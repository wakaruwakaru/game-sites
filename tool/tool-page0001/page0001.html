<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">			
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>HTML Editor for Google Drive</title>
<meta name="description" content="This HTML Editor is a full-featured HTML editor, WYSIWYG Editor, Web Editor that provides you with an extended designing workspace to help you create your own websites, web pages(HTML,HTM) easily. You can open a HTML file to edit from your Google Drive. The WYSIWYG (What You See Is What You Get) html editor is a office like text editor to simplify web content creation. Provides download HTML as PDF, ODT, EPUB, MOBI, RTF(Word DOC), TEX (LaTex Article) formats.">
<meta name="keywords" content="html editor, online html editor, html editor for google drive, drive html editor, wysiwyg html editor, online wysiwyg html editor">

<meta property="og:title" content="HTML Editor for Google Drive"> 
<meta property="og:description" content="This HTML Editor is a full-featured HTML editor, WYSIWYG Editor, Web Editor that provides you with an extended designing workspace to help you create your own websites, web pages(HTML,HTM) easily. You can open a HTML file to edit from your Google Drive. The WYSIWYG (What You See Is What You Get) html editor is a office like text editor to simplify web content creation. Provides download HTML as PDF, ODT, EPUB, MOBI, RTF(Word DOC), TEX (LaTex Article) formats.">
<meta property="og:type" content="website">
<meta property="og:url" content="//htmleditor.kwebpia.net/">
<meta property="og:image" content="//htmleditor.kwebpia.net/img/logo128.png">

<link rel="shortcut icon" href="./favicon.ico">

<style>
body,table,td {
	font-size:13px;
    font-family: Arial, Helvetica, sans-serif; /*Trebuchet MS, Tahoma, Verdana*/
}
html, body{
	background-color:#F2F2F2;
	margin:0;
	width:100%;
	height:100%;
	overflow-y:hidden;
}
#desc td, #desc table, #helptable td{
	font-size:14px;
}
A:link    {color:#0000ff;text-decoration:none;}
A:visited {color:#0000ff;text-decoration:none;}
A:active  {color:#0000ff;text-decoration:underline;}
A:hover  {color:#0000ff;text-decoration:underline;}
.hover { border: 3px dashed #333; }
</style>

<script>//window.CKEDITOR_BASEPATH = 'https://htmleditor.kwebpia.net/js/ckeditor/';</script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="js/common.js"></script>
<script type="text/javascript" src="//iblogbox.github.io/js/htmleditor/ckeditor-4.4.7/ckeditor.js"></script>
<script>var gadb=false;</script>
</head>

<body>
<div id="help" style="display:none">
<table id="helptable" style="margin-bottom:5px">
<tr><td width=16><img src="https://iblogbox.github.io/js/htmleditor/images/viewmag.png"><td>Preview, Print and Save to PDF (Open in the same window)
<tr><td><img src="https://iblogbox.github.io/js/htmleditor/images/viewmag2.png"><td>Preview, Print and Save to PDF (Open in the new window)
<tr><td><img src="https://htmleditor.kwebpia.net/images/text_bold.png"><td>Add a floating textbox to a page (Mouse [MiddleClick] or ctrl/alt+[RightClick]: remove textbox)
<tr><td colspan=2><tr><td colspan=2>
*Source Code Editor<br>
Enable/Disable HTML Tag AutoClose<br>
Ctrl+Space: HTML Tag Autocomplete<br>
Ctrl+Q: CodeFolding On/Off<br>
Ctrl+L: LineWrapping On/Off<br>
<tr><td colspan=2><tr><td colspan=2>
*Source Code Editor Find <br>
Ctrl+F: Find<br>
Ctrl+Shift+F: Replace<br>
Ctrl+Shift+R: Replace All<br>
Ctrl+G: Find Next<br>
Ctrl+Shift+G: Find Previous<br>
/re/ syntax: regexp
</table>
</div>
<textarea id="gtextboxscript_data" style="display:none">
function _dragElement20220124_init_(){
	var a=document.getElementsByTagName("DIV");
	if(!a || a.length==0)return;
	for(var i = 0; i < a.length; i++){    
		if(a[i].id && a[i].id.indexOf("_textbox20220124_")==0){
			_dragElement20220124_(a[i]);
		}
	}
}
function _dragElement20220124_(elmnt){
  if(!elmnt)return;
  elmnt.onmousedown=dragMouseDown;
  function dragMouseDown(e) {
    e = e || window.event; if(!e)return;
	//console.log(e);
	var b2=e.target || e.srcElement;
	//console.log(b2.tagName, b2.className);
	if(!b2 || !/^(div|span)$/i.test(b2.tagName) || (b2.className || '').indexOf('resizer')>=0)return;			
	if(e.button==1 || (e.button==2 && (e.ctrlKey || e.altKey))){
		var answer=confirm("Do you want to remove this textbox?");
		if(!answer)return;
		document.onmousemove=null;
		if(elmnt.parentNode) elmnt.parentNode.removeChild(elmnt);
		return;
	}else if(e.button!=0){
		return;
	}
    //e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
	elmnt.style.cursor="move";
  }
  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
	elmnt.style.cursor="move";
 }
  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
	elmnt.style.cursor="";
  }
}
</textarea>

<table cellpadding=0 cellspacing=0><tr>
<td width=162 valign=top>
<div style="margin-top:5px;margin-left:6px">
<table cellpadding=0 cellspacing=0><tr>
<td><button type="button" id="btn_open" onclick="gd_open_picker()" title="Open a HTML file from Google Drive" style="white-space:nowrap"><img src="//iblogbox.github.io/js/gdrive/product16.png" width=16 align="absmiddle"> Open a File<br>from Google Drive</button>
</table>
<button type="button" id="gd_btn_reopen" onclick="gd_reopen()" style="display:none" title="Reopen the file loaded from drive.google.com">Reopen</button>
<div id="downlink" style=""></div>
</div>
<div style="margin-top:10px;margin-left:5px;margin-right:5px;">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" onerror="gadb=true;"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-1113541014872557"
     data-ad-slot="2403854301"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div>

<td valign=top>

<div id="dfile1" style="display:inline;position:absolute;left:-1000px"></div>
<script>document.getElementById("dfile1").innerHTML='<input type="file" id="fileload1" name="files[]" style="width:90px">';</script>

<div style="margin-left:7px">
<table id="topmenu" style="white-space:nowrap"><tr>
<td><button type="button" id="btn_gsave" title="Save to Google Drive" style="margin-left:2px" onclick="proc_save()"><img src="//iblogbox.github.io/js/gdrive/product16.png" align="absbottom"> Save</button>
<td><button id="btn_open2" onclick="proc_fileopen()" title="Open a file from computer, or Drop a file here">Open</button>
<td><button type="button" id="btn_gsave2" onclick="proc_save(true)" disabled=true title="Save the unmodified original data to Google Drive.">Problem? Save from original</button>
<td>
<td><div id="d_history"></div>
<td><button type="button" onclick="history_onchange()">Open</button> <button type="button" onclick="history_clear()">Clear all</button>
<td><div id="d_title" style="color:green"></div>
</table>

<table id="loading" style="position:absolute;left:182px;top:30px;background: white;padding:3px;border:0px solid silver;-webkit-box-shadow: 0 0 10px #999;-moz-box-shadow: 0 0 10px #999; box-shadow: 0 0 10px #999;"><tr>
<td><img src="/images/wait.gif">
<td>Loading... Please wait a moment.
</table>

<textarea cols="80" id="editor1" name="editor1" rows="10"></textarea>
</div>

<td valign=top>
<div style="margin-top:54px;margin-left:5px;">
<script type="text/javascript">
    google_ad_client = "ca-pub-1113541014872557";
    google_ad_slot = "2403854301";
    google_ad_width = 160;
    google_ad_height = 600;
</script>
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>

</table>

<script>
function replace_charset(texts,isadd){
	if(!texts) texts='';
	if(isadd){
		return '<meta http-equiv="Content-Type" content="text/html; charset=utf-8">'+texts;
	}else{
		return texts.replace(/<meta(?!\s*(?:name|value)\s*=)(?:[^>]*?content\s*=[\s"']*)?([^>]*?)[\s"';]*charset\s*=[\s"']*([^\s"'/>]*)/gi, function(a1,a2,a3,a4,a5,a6,a7,a8){
			return '<meta http-equiv="Content-Type" content="text/html; charset=utf-8';
		});
	}	
}
function getOffset(b) {
    var a = 0;
    var c = 0;
    while (b && !isNaN(b.offsetLeft) && !isNaN(b.offsetTop)) {
        a += b.offsetLeft;
        c += b.offsetTop;
        b = b.offsetParent;
    }       
    return {left:a, top:c};
}
function init_loading(){
	var loading=_getid('loading');
	var topmenu=_getid('topmenu');
	var c=getOffset(topmenu);
	loading.style.left=(c.left+5)+'px';
	loading.style.top=(c.top+topmenu.offsetHeight+2)+'px';
}
init_loading();
function proc_resize(flag){
	var w=getWindowWidth();
	var h=getWindowHeight();
	var c=_getid("topmenu");
	var b=_getid('cke_editor1');
		w=w-355;
		h=h-c.offsetHeight;	
	if(w<970) w=970;
	//if(h<780) h=780;
	
	if(flag){
		var w1=getstorage('c_editorwidth');
		w1=parseInt(w1);
		if(!w1 || isNaN(w1)) w1=0;
		if(w1>w) w1=w;
		if(w1<100) w1=w;//1200;
	}else{
		var w1=w;//1200;
		if(b) w1=b.offsetWidth;
				if(w1>w) w1=w;
			}	
	editor.resize(w1, h);
		editor.config.resize_maxWidth=w;
		//CKEDITOR.config.resize_maxWidth=w;
	//CKEDITOR.config.resize_minHeight=h;
}
function proc_clear(){
	var r=Math.floor((Math.random() * 7) + 1);
	if(r!=1)return;
	var c=['c_editorwidth','c_userbase','c_last_title','c_folder'];
	var s,s1,flag;
	for(var i=localStorage.length-1;i>=0;i--){
		s=localStorage.key(i) || '';
		s1=s.toLowerCase();
		if(s1.indexOf("c_")==0 || s1.indexOf("google_")==0 || s1=='iwcount')continue;
		flag=false;
		for (var j = 0; j < c.length; j++){
			if(c[j]==s){
				flag=true;
				break;
			}
		}
		if(!flag){
			localStorage.removeItem(s);
			//console.log(s);
		}
	}
    var cookies = document.cookie.split(";");
    for (var i = 0; i < cookies.length; i++) {
    	var cookie = cookies[i];
    	var eqPos = cookie.indexOf("=");
    	var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
		s1=trim(name || '');
		if(s1=='PHPSESSID' || s1.indexOf("_")==0 || s1.indexOf("adm")==0)continue;
		//console.log(name);
		var edate='Thu, 01 Jan 1970 00:00:00 GMT';
		document.cookie=name + "=;expires="+edate;
		document.cookie=name + "=;expires="+edate+";path=/";
    	document.cookie=name + "=;expires="+edate+";path=/;domain="+document.domain;
    }
}
function init(){
	if (window.addEventListener){
		window.addEventListener("resize", function(){proc_resize();}, false);
	}else if (window.attachEvent){
		window.attachEvent("onresize", function(){proc_resize();});
	}
	history_display();
	proc_clear();

	var a=_getid('fileload1');
	if(a){
		a.onchange=function(e){
			if(!e || !e.target){
				alert("This browser does not support.");
				return;
			}
			handleFileSelect(e.target.files);	
		}
		a.setAttribute('accept', '.html, .htm, .txt');
	}

	var holder = document;
	holder.ondragover = function(e){ 
		//_getid('btn_open2').className = 'hover'; 
		try{var ua=navigator.userAgent;
			if(ua && ua.indexOf("Chrome")>=0){					
				if(e.originalEvent) e = e.originalEvent;
				if(e.dataTransfer){
					var b = e.dataTransfer.effectAllowed;
					e.dataTransfer.dropEffect = ('move' === b || 'linkMove' === b) ? 'move' : 'copy';
				}
			}
		}catch(err){}
		return false; 
	};
	holder.ondragend = function(){ 
		//_getid('btn_open2').className = '';
		return false;
	};
	holder.ondrop = function (e){
		//_getid('btn_open2').className = '';
		e.preventDefault();		
		var files=e.dataTransfer.files; //firefox bug
		if(editor && editor.checkDirty()){
			var answer=confirm("Not saved. Would you just discard?");
			if(!answer)return false;
		}		
		handleFileSelect(files);
		return false;
	};
}
window.onload = function(){
	init();	
	window.onunload=function(){
		var b=_getid('cke_editor1');
		if(b) setstorage('c_editorwidth',b.offsetWidth);
	}
}

var access_token;
var gdata={'fileIdx':'','resp':'','data':''}, gdatalist=[];
var gmaxhistory=10;

function history_display(){
	var a=_getid("d_history");
	var s='<select id="history" onchange="history_onchange()" style="width:250px"><option value="">*History, Select a file, Max '+gmaxhistory+' limit.';
	var s1;
	for(var i=gdatalist.length-1;i>=0;i--){
		s1='';
		if(gdata.fileIdx==gdatalist[i].fileIdx) s1=' selected';
		s+='<option value="'+gdatalist[i].fileIdx+'"'+s1+'>'+gettitle(gdatalist[i].resp);		
		if(gdatalist[i].resp && gdatalist[i].resp.islocal) s+=' (Local)';	
		if(gdatalist[i].data2) s+=' (Modified)'; 
		if(gdatalist[i].deleted) s+=' (Deleted)'; 		
	}
	s+='</select>';
	a.innerHTML=s;
}
function history_onchange(){
	var a=_getid("history");
	if(!a || !a.value)return;
	for(var i = 0; i < gdatalist.length; i++){    
		if(gdatalist[i].fileIdx==a.value){
			if(editor.checkDirty()){
				var answer=confirm("Not saved. Would you just discard?");	//gettitle(gdatalist[i].resp)+"\n\nDo you want to open this file again?"
				if(!answer)return;
			}
			var s;
			if(gdatalist[i].data2){
				var answer=confirm('It has modified. Do you want to open the last modified data?\n\nOK: Open the last modified data\nCancel: Open the unmodified original data');				
				if(answer) s=gdatalist[i].data2;
				else s=gdatalist[i].data;
			}else{
				s=gdatalist[i].data;
			}
			gdata=gdatalist[i];			
			proc_open(s, gdatalist[i].resp, true);
			setdown(gdatalist[i].resp);
			break;
		}
	}
}
function history_clear(){
	var answer=confirm("Clear all history.\n\nAre you sure?");				
	if(!answer)return;
	/*for(var i = 0; i < gdatalist.length; i++){    
		if(gdata.fileIdx!=gdatalist[i].fileIdx){
			gdatalist[i].data=null;
		}
	}*/
	gdatalist=[];
	history_display();
}

var gbaseurl="https://googledrive.com/host/";
function base_get(){
	var s=getstorage('c_userbase');
	var a=[];
	if(!window.JSON) return a;
	try{
		a=JSON.parse(s);
	}catch(err){
		a=[];
	}
	if(!a) a=[];
	if(a.length>20){
		a.splice(0,1);
		setstorage('c_userbase',JSON.stringify(a));
	}
	return a;
}
function base_edit(){
	var remove;
	var resp=gdata.resp;
	var s=gdata.baseHref || '';
	var s1=prompt("Enter a base public URL for this HTML document.\nEmpty value will be changed to the default base URL.\n\nex) https://googledrive.com/host/xxxxxxxxxxx(Folder, File ID)/ (Google Drive Website Publish)",s);	
	if(s1==null)return;
	if(s1==''){		
		if(resp && resp.parents && resp.parents[0] && resp.parents[0].id){
			s1=gbaseurl+resp.parents[0].id+"/";
			remove=true;
		}
	}
	if(s==s1) return;
	gdata.baseHref=s1;
	for(var i = 0; i < gdatalist.length; i++){    
		if(gdatalist[i].fileIdx==gdata.fileIdx){
			gdatalist[i].baseHref=s1;
			break;
		}
	}
	if(resp && resp.id){
		var d=base_get();
		if(remove){
			for(var i = 0; i < d.length; i++){    
				if(d[i].id==resp.id){
					d.splice(i,1);
					break;
				}
			}			
		}else{
			d.push({'id':resp.id, 'baseHref':s1});
		}
		setstorage('c_userbase',JSON.stringify(d));
	}
	CKEDITOR.config.baseHref=s1;
	editor.setData(editor.getData());
}

function proc_adddata(resp,data,raw){
		if(gdatalist.length>gmaxhistory){
			gdatalist.splice(0,1);
		}
		var a={};
		a.fileIdx=(new Date()).getTime();
		a.resp=resp;
		a.data=data;
		if(raw) a.raw=raw;
		if(resp && resp.parents && resp.parents[0] && resp.parents[0].id){
			a.baseHref=gbaseurl+resp.parents[0].id+"/";
			/*var d=base_get();
			for(var i = 0; i < d.length; i++){    
				if(d[i].id==resp.id){
					a.baseHref=d[i].baseHref;
					break;
				}
			}*/			
		}
	if(!a.baseHref) a.baseHref=gbaseurl;
	/*try{
		var parser = new DOMParser();
		var doc = parser.parseFromString(data, "text/html");//application/xml
		if(doc){
			var b=doc.getElementsByTagName('base');
			for(var i = 0; i < b.length; i++){
				s=trim(b[i].href || '').toLowerCase();
				if(s.indexOf("http://")==0 || s.indexOf("https://")==0){
					a.baseHref='';
				}
				break;
			}
		}
	}catch(err){}*/
		gdatalist.push(a);
		gdata=a;
		_getid("btn_gsave2").disabled=false;
}
function proc_open(data, resp, nohistory, raw){
	if(!editor)return;

	if(!nohistory){
		proc_adddata(resp,data,raw);
	}	
	gd_settitle(resp);

	editor.resetDirty();
	editor.resetUndo();	
	CKEDITOR.config.baseHref=gdata.baseHref || gbaseurl;
	editor.setData(data,{
		'callback':function(){
			editor.resetDirty();
			setTimeout(function(){
				editor.resetUndo();				
			},100);
			history_display();
		}
	});
}

function proc_save(original){
	if(gadb){alert('Please disable the adblock for free use.');return;}	if(!gd_issupported){
		alert("This browser does not support.");
		return;
	}
	if(!gd_loaded || !gd_pickerloaded){
		alert('Not loaded library. Please try again in a few minutes.');
		return;
	}
	if(!editor)return;
	if(gd_isdownloading){
		alert("It's working. Please try again later. or Cancel the current job.");
		return;
	}
	//if(original) alert('Save the unmodified original data to Google Drive. Restore to original file data.');
	if(!gdata){
		gdata={};
		gdata.fileIdx='';
		gdata.resp='';
		gdata.data='';
	}
	function getok(){
		var data2={};
		data2.raw=gdata.raw;
		if(original && gdata.raw){
			data2.data=gdata.data;
			var reader = new FileReader();
	        reader.onload = function(e){
				var s=reader.result || '';
				if(s) data2.dataraw=s.substr(s.indexOf(",")+1,s.length);					
				getok2(data2);
	        }
		    reader.readAsDataURL(gdata.raw);
		}else{
			if(original) data2.data=gdata.data;
			else data2.data=replace_charset(editor.getData());
			getok2(data2);
		}
	}
	function getok2(data2){		
		data2.fileIdx=gdata.fileIdx;
		data2.resp=gdata.resp;
		data2.contentType='text/html';
		data2.filename=gettitle(gdata.resp);
		data2.original=original;
		if(original) _getid('divutf8').style.display='none';
		else _getid('divutf8').style.display='';
		
		var a=_getid("gd_savewindow");
		a.style.left="2px";
		a.style.top="2px";
		a.style.display='';

		var gc_filename=_getid("gc_filename");
		var gc_mimetype=_getid("gc_mimetype");
		var gc_targetfolder=_getid("gc_targetfolder");
		var gc_save=_getid("gc_save");
		var gc_usesaveas=_getid("gc_usesaveas");
		var gc_saveas=_getid("gc_saveas");
		var gc_selectfolder=_getid("gc_selectfolder");
		var gc_resetfolder=_getid("gc_resetfolder");
		var gc_usesaveas2=_getid("gc_usesaveas2");
		var s=getstorage("c_folder");
		var c={};
		try{c=JSON.parse(s);}catch(err){}
		gc_mimetype.innerHTML='None';
	
		function set_save(){
			gc_filename.value=data2.resp.title;
			gc_filename.disabled=true;
			gc_mimetype.innerHTML=data2.resp.mimeType || 'None';
			s='';
			if(data2.resp && data2.resp.parents && data2.resp.parents[0] && data2.resp.parents[0].id){
				s='<a href="'+gd_weburl()+'#folders/'+data2.resp.parents[0].id+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+data2.resp.parents[0].id+'">Folder of this file</a>';
			}
			gc_targetfolder.innerHTML=s;

			gc_save.disabled=false;
			gc_usesaveas.style.display='';
			gc_saveas.disabled=true;
			gc_selectfolder.disabled=true;			
			gc_resetfolder.disabled=true;			
		}
		function set_saveas(){
			gc_filename.value=data2.filename || (data2.resp && data2.resp.title) || getstorage('c_last_title') || '';
			gc_filename.disabled=false;
			if(data2.resp) gc_mimetype.innerHTML=data2.resp.mimeType || 'None';

			if(c && c.folderid) s='<a href="'+gd_weburl()+'#folders/'+c.folderid+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+c.folderid+'">'+henc(c.name || 'No Name')+'</a>';
			else s='Folder is not specified.';
			gc_targetfolder.innerHTML=s;

			gc_save.disabled=true;
			gc_saveas.disabled=false;
			gc_selectfolder.disabled=false;
			gc_resetfolder.disabled=false;
		}

		gc_usesaveas2.checked=false;
		if(data2.resp && !gdata.deleted && !data2.resp.islocal){			
			set_save();
			gc_usesaveas.style.display='';
		}else{
			set_saveas();
			gc_usesaveas.style.display='none';
		}

		gc_usesaveas2.onclick=function(){
			if(this.checked){
				set_saveas();
			}else{
				set_save();
			}
		}
		gc_save.onclick=function(){
			if(!data2.resp.mimeType)data2.resp.mimeType='';
			var s=data2.resp.mimeType.toLowerCase();
			if(s!='text/html'){
				for(var i=1; i <= 2; i++){    
					var answer=confirm('Type of this file: "'+data2.resp.mimeType+'"\n\nWarning, This file may not be HTML-type file. Would you like to overwrite it? ['+i+'/2]');
					if(!answer)return;
				}
			}
			a.style.display='none';
			proc_update(data2);
		}
		gc_saveas.onclick=function(){
			if(!trim(gc_filename.value)){
				alert('Please enter a filename.');
				gc_filename.focus();
				return;
			}
			a.style.display='none';
			var s=getstorage("c_folder");
			var c={};
			try{c=JSON.parse(s);}catch(err){}
			proc_insert(data2, c.folderid);			
		}
	}
	gd_login(function(result){
		if(!result) return;
		getok();
	});
}

function gd_upload(method,boundary,body,path,param,callback){		
	function error(s){
		var result={};
		result.error={"message":s};
		callback(result);
	}
	access_token=gapi.auth.getToken().access_token;
	if(!access_token){
		error('Error!! No access token.');
		return;
	}

	_getid("downlink").innerHTML="<table><tr><td><div id='gd_progress'>Uploading...</div>&nbsp;<a href='#' id='gd_cancel' style='font-size:14px;display:none'>Cancel</a></table>";
	try{
		var xhr = new XMLHttpRequest();
		var c=_getid('gd_cancel');
		if(c){
			c.style.display='';
			c.onclick=function(){
				xhr.abort(); 
				error('Canceled by user.');
				return false;
			}
		}
		xhr.open(method, 'https://www.googleapis.com'+path+'?'+param, true);
		xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
		xhr.setRequestHeader('Content-Type', 'multipart/mixed; boundary="' + boundary + '"');		
		gd_lastprogress=(new Date()).getTime();
		if(xhr.upload){
			xhr.upload.onprogress=function(event){
				if(gd_lastprogress){
					var elaspetime = new Date();
					var dt=(elaspetime.getTime()-gd_lastprogress)/1000;
					if(dt<1)return;
					gd_lastprogress=elaspetime.getTime();
				}
				var a=event;
				var total=a.totalSize || a.total || 0;
				var current=a.position || a.loaded  || 0;
				var b=_getid("gd_progress");
				if(b) b.innerHTML='&nbsp;Uploading... ('+number_format(current)+'/'+number_format(total)+')';
			};
		}
	    xhr.onload = function(){
			if(this.status == 200){
				var result;
				try{
					result=JSON.parse(this.response);
				}catch(err){
					result='';				
				}
				if(result) callback(result);
				else error('Results value error');				
			}else{
				var s="Error (status) " + this.status + "("+this.statusText+") occurred while uploading the file. or Check the target folder.";
				error(s);
			}
		};
		xhr.onerror = function(e){      
			var s="Error " + e.target.status + " occurred while uploading the file.";
			error(s);
		};
		xhr.send(body); 	
	}catch(err){
		error(err+'\n\nor This browser does not support. Please upgrade your browser.');
	}
}
function proc_insert(data, folderid){
	var title=trim(gc_filename.value);
	go();

function go(){
	if(!title)return;	
	setstorage('c_last_title',title);

	function insertFile2(callback){
		var boundary = '-------314159265358979323846';
        var delimiter = "\r\n--" + boundary + "\r\n";
        var close_delim = "\r\n--" + boundary + "--";

          var contentType = data.contentType;
          var metadata = {
            'title': title,
            'mimeType': contentType
          };
		if(!folderid){
			if(data.resp && data.resp.parents && data.resp.parents[0] && data.resp.parents[0].id) 
				folderid=data.resp.parents[0].id;
		}
		if(folderid) metadata.parents=[{"id":folderid}];

		var multipartRequestBody =
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: ' + contentType + '\r\n';
		if(data.dataraw){
			multipartRequestBody+='Content-Transfer-Encoding: base64\r\n';
			multipartRequestBody+='\r\n' + data.dataraw + close_delim;
		}else{
			multipartRequestBody+='\r\n' + data.data + close_delim;
		}

		gd_upload('POST',boundary,multipartRequestBody,'/upload/drive/v2/files/','uploadType=multipart&convert=false',callback);
	}
	
	gd_startsave();
	insertFile2(function(result){
		gd_endsave();
		if(result.error || !result.downloadUrl){
			var s='Error. ';
			_getid("downlink").innerHTML='&nbsp;<font style="color:green">'+s+'</font>';
			if(result.error){
				if(result.error.message) s+=result.error.message+' ';
				if(result.error.code==401){
					s+='Login or Authorize Error.';
				}
			}
			alert(s);
		}else if(result.downloadUrl){
			proc_adddata(result, data.data, data.raw);

			gd_settitle(result);
			history_display();
			editor.resetDirty();
			gd_saveok(data, result);
		}		
	});
}
}

function proc_update(data){

function updateFile2(callback) {
  var boundary = '-------314159265358979323846';
  var delimiter = "\r\n--" + boundary + "\r\n";
  var close_delim = "\r\n--" + boundary + "--";

    var contentType = data.contentType;
	var resp2=JSON.parse(JSON.stringify(data.resp));
	resp2.mimeType=contentType;

	var multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(resp2) +
        delimiter +
        'Content-Type: ' + contentType + '\r\n';
	if(data.dataraw){
		multipartRequestBody+='Content-Transfer-Encoding: base64\r\n';
		multipartRequestBody+='\r\n' + data.dataraw + close_delim;
	}else{
		multipartRequestBody+='\r\n' + data.data + close_delim;
	}
		
	gd_upload('PUT',boundary,multipartRequestBody,'/upload/drive/v2/files/'+data.resp.id,'uploadType=multipart&alt=json&convert=false',callback);
}
function _touch(id){
	 var request = gapi.client.drive.files.touch({
		'fileId': id
	});
	request.execute(function(resp){
	});
}

	gd_startsave();
	updateFile2(function(result){
		gd_endsave();
		if(result.error || !result.downloadUrl){
			var s='Error. ';
			_getid("downlink").innerHTML='&nbsp;<font style="color:green">'+s+'</font>';
			if(result.error){
				if(result.error.message) s+=result.error.message+' ';
				if(result.error.code==401){
					s+='Login or Authorize Error.';
				}else if(result.error.code==500){ //not exist
				}
			}
			alert(s);
		}else if(result.downloadUrl){
			data.resp.mimeType=result.mimeType;
			for(var i = 0; i < gdatalist.length; i++){    
				if(gdatalist[i].fileIdx==data.fileIdx){
					if(!data.original) gdatalist[i].data2=data.data;
					break;
				}
			}
			if(gdata.fileIdx==data.fileIdx){
				if(!data.original) gdata.data2=data.data;
				gd_settitle(result);
			}
			if(!data.original){
				history_display();
				editor.resetDirty();
			}
			gd_saveok(data, result);		
			//_touch(result.id);
		}							
	});
}
function gd_startsave(){
	gd_isdownloading=true;
	_getid('btn_open').disabled=true;
	_getid('btn_gsave').disabled=true;
	_getid('btn_gsave2').disabled=true;
	_getid("downlink").innerHTML="<table><tr><td><img src='images/wait.gif' align='absmiddle'><td><div id='gd_progress'>Saving...</div></table>";
}
function gd_endsave(){
	gd_isdownloading=false;
	_getid('btn_open').disabled=false;
	_getid('btn_gsave').disabled=false;
	if(gdata.data) _getid('btn_gsave2').disabled=false;
}
function gd_saveok(data, result){
	var s='&nbsp;<font style="color:green">Save completed.</font>';
	var s1=gd_getlink(result,true);
	if(s1) s+='<br>&nbsp;'+s1;
	_getid("downlink").innerHTML='<table><tr><td>'+s+'<div id=gd_progress></div></table>';
}
function gd_getlink(result,del){
	var s='';
	if(result && result.parents && result.parents[0] && result.parents[0].id){
		s+='<a href="'+gd_weburl()+'#folders/'+result.parents[0].id+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+result.parents[0].id+'">Folder</a>';
		var link=result.alternateLink || result.webContentLink;
		if(link) s+=' &nbsp;<a href="'+link+'" target="_blank" title="View on the Google Drive, '+henc(result.mimeType)+'">View</a>';
		if(del) s+=' &nbsp;<a href="#" onclick="proc_delete(\''+result.id+'\',this);return false" data="'+escape(result.title || '')+'" title="Delete this file">Delete</a>';
	}
	return s;
}
function gd_settitle(resp){
	var s=gettitle(resp)+getsize(resp.fileSize);
	s=henc(s);
	var s1=gd_getlink(resp);
	if(s1) s+=' &nbsp;'+s1;
	var a=_getid('d_title');
	a.innerHTML=s;
	s1=resp.mimeType || '';	
	if(resp.islocal){
		if(s1) s1+=' ';
		s1+='(Open from local computer)';
	}
	a.title=s1;
}
function proc_delete(fileId,f){
	function proc_log(s){
		var a=_getid("gd_progress");
		if(a) a.innerHTML=' &nbsp;'+s;
	}
function go(){
	proc_log('<font class=welcome>Deleting...</font>');
	var request = gapi.client.drive.files['delete']({
		'fileId': fileId
	});
	request.execute(function(resp){
		if(resp.result && !resp.message){
			proc_log('<font style="color:green">Delete completed.</font>');
			var flag;
			for(var i = 0; i < gdatalist.length; i++){    
				if(gdatalist[i].resp && gdatalist[i].resp.id==fileId){
					flag=true;
					gdatalist[i].deleted=true;
					if(gdata.fileIdx==gdatalist[i].fileIdx){
						gdata.deleted=true;
					}					
				}
			}
			if(flag)history_display();
		}else{
			proc_log('<font style="color:red">Delete failed.</font>');
			if(resp.message) alert(resp.message+' '+unescape(f.getAttribute('data')));
		}
	});
}
	gapi.client.load('drive', 'v2', function(){
		go();
	});
}
</script>

<div id="gd_savewindow" class="gd_div" style="z-index:100;display:none;padding:10px">
<table style="white-space:nowrap">
<tr><td colspan=2 align=center>
<div id="divutf8">The HTML document will be saved only as UTF-8 unicode encoding.<br>This HTML file's encoding will be converted to UTF-8 type.</div>
<tr><td>Filename<td><input type=text id="gc_filename" style="width:350px">
<tr><td>Current FileType&nbsp;<td><div id="gc_mimetype" style="width:350px"></div>
<tr><td>Target Folder&nbsp;<td><div id="gc_targetfolder" style="width:350px;white-space:nowrap;overflow:hidden"></div>
<tr><td>
<tr><td colspan=2 align=center>
	<button id="gc_save" style="font-weight:bold" class=middle>Save</button> <label id="gc_usesaveas"><input type=checkbox id="gc_usesaveas2">Use Save as</label> <button id="gc_saveas" style="font-weight:bold" class=middle>Save as..</button> <button id="gc_selectfolder" onclick="gd_open_picker(2)">Select Folder</button> <button id="gc_resetfolder" onclick="proc_setfolder('','')" title="Folder is not specified.">Reset</button>
<tr><td>
<tr><td colspan=2 align=center>
	<button onclick="_getid('gd_savewindow').style.display='none';"><img src="images/close.png" align="absmiddle"> Close</button>
</table>
</div>

<style>
.gd_div{background-color:#FFFFE1;position:absolute;overflow:hidden;-webkit-box-shadow: 0 0 25px #999;-moz-box-shadow: 0 0 25px #999;box-shadow: 0 0 25px #999;}
</style>
<div id="layer_message" class="gd_div" style="z-index:10001;display:none;"></div>
<div id="gd_window" class="gd_div" style="z-index:10000001;display:none;"></div>
<div id="gd_btn_login" class="gd_div" style="z-index:10000000;display:none;">
<table>
<tr><td align=center><button onclick="gd_login_manual()" style="font-size:20px"><img src="//iblogbox.github.io/js/gdrive/product20.png" align="absmiddle"> Login & Authorize</button> <button onclick="gd_login_close()" style="font-size:20px">Close</button>
<tr><td>To use this app, Please login to the Google Drive and authorize this app or website.
<br>(Note: If your browser block or disable the third-party cookies, this login does not work correctly.)
</table>
</div>
<script>
var CLIENT_ID = '67823851872-1u2c89ghg15vve1kjdfikmmdvp23nesp.apps.googleusercontent.com';
var SCOPES = [
	'https://www.googleapis.com/auth/drive.install',
	'https://www.googleapis.com/auth/drive.file'
];
var gd_developerKey='AIzaSyCn1uv7G0WB5t31xFY_5JS1dPTI9ZZXPF8';
var gd_mimetype="";
var gd_export_extension=["html","htm"];
var gd_state='';

var gd_picker,gd_picker2,gd_loaded,gd_pickerloaded,gd_lastprogress,gd_issupported,gd_isdownloading,gd_load_timer,gd_bloburl,gd_state2;
var gd_loginexp=0;
var gd_callback;
var ismsie=false;
if(navigator.appName!="Netscape"){
	if(navigator.userAgent.indexOf("MSIE")>=0) ismsie=true;
}

function gd_btn_login2(e,callback){
	function go(a){
		if(a && a.style.display==''){
			var x=getScrollLeft()+((getWindowWidth()-a.clientWidth) / 2);
			var y=getScrollTop()+((getWindowHeight()-a.clientHeight) / 2);
			a.style["border"]="1px solid #000000";
			a.style["padding"]="10px";
			a.style.left=x+"px";
			a.style.top=y+"px";
		}
	}
	go(_getid("gd_btn_login"));
	go(_getid("gd_window"));	
	setTimeout(function(){
		go(_getid("gd_btn_login"));
		go(_getid("gd_window"));	
		if(callback)callback();
	},10);
}
function gd_btn_login(isshow){
	var a=_getid("gd_btn_login");
	if(isshow){
		a.style.display='';
		gd_btn_login2();
	}else{
		a.style.display='none';
	}
}
function gd_login_close(){
	gd_btn_login(false);
	_getid("downlink").innerHTML='';
	gd_state='';
}
function gd_login_manual(){
	var p={'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': false};
	if(gd_userId){p['login_hint']=gd_userId;p['authuser']=-1;}
	gapi.auth.authorize(p, function (authResult){ 
		if (authResult && !authResult.error){
			gd_loginexp=(new Date()).getTime()+parseInt(authResult.expires_in*0.7*1000);
			gd_btn_login(false);gd_info();
			show_message("Login ok!!");
			if(gd_callback) gd_callback(true);
			else gd_open_state(true);
		}else{
			gd_btn_login(true);
			show_message("Login failed!!");
		}
	});
}
function gd_login(callback,react){
	if(gd_loginexp==0 || gd_loginexp<(new Date()).getTime()){
	}else{
		callback(true);
		return;
	}
	var p={'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': true};
	if(gd_userId){p['login_hint']=gd_userId;p['authuser']=-1;}
	gapi.auth.authorize(p, function (authResult){
		if (authResult && !authResult.error){
			gd_loginexp=(new Date()).getTime()+parseInt(authResult.expires_in*0.7*1000);
			gd_btn_login(false);gd_info();
			callback(true);
		}else{
			show_message("Login failed!!");
			gd_btn_login(true);
			callback(false);
			if(react) gd_callback=callback;
			else gd_callback=null;
		}
	});
}

function gd_loadpicker() {		
	gapi.load('picker',{'callback': function(){
			gd_pickerloaded=true;
		}
	});	
}
function proc_setfolder(id,name){
	var c={};
	c.folderid=id;
	c.name=name;
	var s;
	if(c.folderid) s='<a href="'+gd_weburl()+'#folders/'+c.folderid+'" onclick="gd_clickweburl(this)" target="_blank" title="Folder ID: '+c.folderid+'">'+henc(c.name || 'No Name')+'</a>';
	else s='Folder is not specified.';
	_getid('gc_targetfolder').innerHTML=s;	
	if(window.JSON) setstorage("c_folder",JSON.stringify(c));
}
function gd_createpicker(kind) {
	function gd_pickercallback(data) {
		if (data.action == google.picker.Action.PICKED) {
			if(data.docs && data.docs.length>0 && data.docs[0].id){
				if(!kind){
					gd_loadfiles(data.docs);
				}else if(kind==2){
					if(data.docs[0].type!="folder"){
						alert("It's not a folder.");
						return;
					}
					proc_setfolder(data.docs[0].id, data.docs[0].name);
				}
			}
		}
	}
	var access_token=gapi.auth.getToken().access_token;
	if(!access_token){
		alert('Error!! No access token.');
		return;
	}
	if(!kind){
	 if(!gd_picker){
	  var view2 = new google.picker.DocsView(google.picker.ViewId.DOCS);
	  if(gd_mimetype) view2.setMimeTypes(gd_mimetype);
	  view2.setMode(google.picker.DocsViewMode.LIST);

		var view4 = new google.picker.DocsView();
		view4.setIncludeFolders(true);
		view4.setParent("root");
		view4.setMimeTypes(gd_mimetype);
		view4.setMode(google.picker.DocsViewMode.LIST);
		var view5 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);

      gd_picker = new google.picker.PickerBuilder()
		  //.enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
		  .setLocale("en") //window.navigator.language || window.navigator.userLanguage || "en"
		  .setAppId(CLIENT_ID.split("-")[0]) //scope
          .setOAuthToken(access_token)
          .addView(view2)
		  .addView(view4)
		  .addView(view5)
          .addView(new google.picker.DocsUploadView())
          .setDeveloperKey(gd_developerKey)
          .setCallback(gd_pickercallback)
          .build();
	 }
	 gd_picker.setVisible(true);
	}else if(kind==2){
	  if(!gd_picker2){
		var docsView = new google.picker.DocsView()
          .setIncludeFolders(true) 
		  .setParent("root")
          .setMimeTypes('application/vnd.google-apps.folder')
		  .setMode(google.picker.DocsViewMode.LIST)
          .setSelectFolderEnabled(true);
		var view5 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);

        gd_picker2 = new google.picker.PickerBuilder()
		  .setLocale("en") 
		  .setAppId(CLIENT_ID.split("-")[0]) //scope
          .setOAuthToken(access_token)
		  .setDeveloperKey(gd_developerKey)
		  .setTitle("Select a folder to save as..")
          .addView(docsView)
		  .addView(view5)
          .setCallback(gd_pickercallback)
          .build();
	  }
	  gd_picker2.setVisible(true);
	}
}

	function gettitle(resp){
		if(resp.title){
			if(resp.exportLinks) s=resp.title+'.'+resp.fileExtension;
			else s=resp.title;
		}else{
			s='No_Title.html';
		}
		return s;
	}			
	function getsize(fileSize){
		if(!fileSize) return '';
		function humanFileSize(bytes){
			var thresh = 1024;
			if(bytes < thresh) return bytes + ' B';
			var units = ['kB','MB','GB','TB','PB','EB','ZB','YB'];
			var u = -1;
			do {
				bytes /= thresh;
				++u;
			} while(bytes >= thresh);
			return bytes.toFixed(1)+' '+units[u];
		}
		return ' ('+humanFileSize(fileSize)+')';
	}	
	function setdown(resp,url){
		_getid("downlink").innerHTML='';
		if(!resp)return;
		if(!url){
			if(resp.downloadUrl){
				url=resp.downloadUrl;
			}else if(resp.exportLinks){
				for (x in resp.exportLinks){	
					for(var i = 0; i < gd_export_extension.length; i++){    
						if(x.toLowerCase().indexOf(gd_export_extension[i])>=0){
							url=resp.exportLinks[x];
							resp.fileExtension=gd_export_extension[i];
							break;
						}						
					}					
					if(url)break;
				}
			}
			if(!url || !access_token) return;
			url=url+'&access_token='+encodeURIComponent(access_token);
		}
		_getid("downlink").innerHTML='<table><tr><td><a id="adownlink" style="font-size:15px">Download the file</a></table>';
		var a=_getid("adownlink");
		if(a){
			a.href=(resp.downloadUrl && resp.webContentLink) || url;
			var s=gettitle(resp);
			a.download=s || "";
			a.title=(s || "")+getsize(resp.fileSize);
			a.target='_blank';
		}
	}

function gd_loadfiles(docs,isstart){
	if(gadb){alert('Please disable the adblock for free use.');return;}	if(gd_isdownloading){
		alert("It's working. Please try again later. or Cancel the current job.");
		return;
	}
	function end(){
		gd_isdownloading=false;
	}
	function go(idx){
		if(idx>docs.length-1){
			end();return;
		}
		function next(){
			idx++;
			go(idx);
		}
		if(docs[idx].id){
			gd_loadfile(docs[idx].id,docs.length,idx+1,function(){
				//next();
				end();
			});
		}else{
			next();
		}
	}
	gapi.client.load('drive', 'v2', function(){
		gd_isdownloading=true;
		go(0);
	});
}
function gd_loadfile(fileId,total,currentidx,callback){
	var prefix='';//'['+currentidx+'/'+total+'] ';
	_getid("downlink").innerHTML="<table><tr><td><div id='gd_progress'>"+prefix+"Ready...</div></table>";

	function go(){
		var request = gapi.client.drive.files.get({
			'fileId': fileId
		});
		request.execute(function(resp){
			function end(abort){
				clearTimeout(messagetimer);
				hide_message();
				var a=_getid("downlink");
				if(a.innerHTML && a.innerHTML.indexOf("adownlink")<0){
					_getid("downlink").innerHTML='';
				}
				if(!abort && callback) callback();
				else gd_isdownloading=false;
			}
			function error(s){				
				if(resp) s=gettitle(resp)+getsize(resp.fileSize)+'\n\n'+s;
				alert(prefix+s);
			}
			//console.log(resp);

			var downloadurl;
			if(resp.downloadUrl){
				downloadurl='https://www.googleapis.com/drive/v2/files/'+resp.id+'?alt=media';//resp.downloadUrl;
				go();
			}else if(resp.exportLinks){
				for (x in resp.exportLinks){	
					for(var i = 0; i < gd_export_extension.length; i++){    
						if(x.toLowerCase().indexOf(gd_export_extension[i])>=0){
							downloadurl=resp.exportLinks[x];
							resp.fileExtension=gd_export_extension[i];
							break;
						}						
					}					
					if(downloadurl)break;
				}
				go();
			}else{go();}

		  function go(){
			access_token = gapi.auth.getToken().access_token;
			if(!access_token){
				end(true);
				alert('Error!! No access token.');
				return;
			}
			if(resp.fileSize && parseInt(resp.fileSize)>gmaxsize*1024*1024){
				end();
				error('The file size is too large to view. (around '+gmaxsize+' MB limit)');
				return;
			}
			if(downloadurl){		
					_getid("downlink").innerHTML="<table><tr><td><img src='images/wait.gif' align='absmiddle'><td><div id='gd_progress'>"+prefix+"Downloading...</div><tr><td colspan=2>&nbsp; <a href='#' id='gd_cancel' style='font-size:15px;display:none'>Cancel</a></table>";

				try{
					var xhr = new XMLHttpRequest();
					var c=_getid('gd_cancel');
					if(c){
						c.style.display='';
						c.onclick=function(){
							xhr.abort(); 
							end(true);
							return false;
						}
					}
					gd_lastprogress=(new Date()).getTime();
					xhr.open('GET', downloadurl);//+'&access_token='+encodeURIComponent(access_token)
					xhr.responseType = 'arraybuffer';
					xhr.onprogress=function(event){
						if(gd_lastprogress){
							var elaspetime = new Date();
							var dt=(elaspetime.getTime()-gd_lastprogress)/1000;
							if(dt<1)return;
							gd_lastprogress=elaspetime.getTime();
						}
						var a=event;
						var total=a.totalSize || resp.fileSize || 0;//a.total 
						var current=a.position || a.loaded  || 0;
						var c=_getid('gd_progress');
						if(c) c.innerHTML=prefix+'Downloading... ('+number_format(current)+'/'+number_format(total)+')';
					};
					xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
				    xhr.onload = function(){
						end();
						if(this.status == 200){
							setdown(resp,downloadurl+'&access_token='+encodeURIComponent(access_token));							
							var blob=new Blob([this.response], {type: resp.mimeType || 'text/html'});
							if(blob.size>gmaxsize*1024*1024){
								alert('The file size is too large to edit. (around '+gmaxsize+' MB limit)');
								return;
							}
							proc_read(blob,resp);
							/*if(this.response.length>gmaxsize*1024*1024){
								alert('The file size is too large to edit. (around '+gmaxsize+' MB limit)');
								return;
							}
							proc_open(this.response, resp);*/
						}else{
							var s="Error (status) " + this.status + "("+this.statusText+") occurred while receiving the file.";
							error(s);
						}
					};
					xhr.onerror = function(e){      
						end();
						var s="Error " + e.target.status + " occurred while receiving the file.";
						error(s);
					};
					xhr.send();
				}catch(err){
					end(true);
					alert(err+'\n\nor This browser does not support. Please upgrade your browser.');
				}

			}else{
				end();
				if(resp.error && resp.error.message){
					error(resp.error.message);
				}else{
					error('Error!! Can not find a download URL.');
				}
			}
		  }
		});
	}
	go();
}
var gmaxsize=10;
function proc_read(blob,resp){
	var bloburl=window.URL.createObjectURL(blob);
	var xhr2 = new XMLHttpRequest();
	function _read(mt,callback){														
		xhr2.open('GET', bloburl);
		if(mt) xhr2.overrideMimeType(mt);
		xhr2.onload = function(){
			callback();
		}
		xhr2.onerror = function(e){ 
			window.URL.revokeObjectURL(bloburl);
			alert('Error Reading File.');
		}
		xhr2.send();
	}
	_read('',function(){
		var s=xhr2.response || '';
		var match;	
		var isChromium = window.chrome, isOpera = window.navigator.userAgent.indexOf("OPR") > -1, isIEedge = window.navigator.userAgent.indexOf("Edge") > -1;
		//if(!(isChromium !== null && isChromium !== undefined && isOpera == false && isIEedge == false)){
			match=s.match(/<meta(?!\s*(?:name|value)\s*=)(?:[^>]*?content\s*=[\s"']*)?([^>]*?)[\s"';]*charset\s*=[\s"']*([^\s"'/>]*)/i);
		//}
		if(match && match[2] && match[2].toLowerCase()!='utf-8'){
			//alert(match[2]);
			_read('text/html; charset='+match[2],function(){
				var s=xhr2.response || '';
				window.URL.revokeObjectURL(bloburl);
				proc_open(s, resp, false, blob);
			});
		}else{
			window.URL.revokeObjectURL(bloburl);
			proc_open(s, resp, false, blob);
		}
	});
}
function proc_fileopen(){
	if(editor && editor.checkDirty()){
		var answer=confirm("Not saved. Would you just discard?");
		if(!answer)return;
	}
	_getid('fileload1').click();
}	
function handleFileSelect(files){
	if(!files || files.length==0) return;			
	var f=files[0];
	if(f.size>gmaxsize*1024*1024){
		alert('The file size is too large to edit. (around '+gmaxsize+' MB limit)');
		return;
	}
	var resp={};
	resp.title=f.name;
	resp.fileSize=f.size;
	resp.mimeType=f.type || '';
	resp.islocal=true; //for saveas
	proc_read(f, resp);
}

function gd_open_picker(kind){
	if(!gd_issupported){
		alert("This browser does not support.");
		return;
	}
	if(!gd_loaded || !gd_pickerloaded){
		if(!gd_load_timer) gd_loadscript(function(){gd_open_picker(kind);});
		else alert('Not loaded library. Please try again in a few minutes.');
		return;
	}
	if(!kind && editor && editor.checkDirty()){
		var answer=confirm("Not saved. Would you just discard?");
		if(!answer)return;
	}
	gd_login(function(result){
		if(!result) return;
		gd_createpicker(kind);
	},true);
}

function gd_getparam(s,name){
	name=name+"=";
	name=name.toLowerCase();
	var p1=s.toLowerCase().indexOf(name);
	if (p1<0) return "";
	s=s.substr(p1+name.length);
	var p2=s.toLowerCase().indexOf("&");
	if (p2>=0) {
		return s.substr(0,p2);
	} else {
		return s;
	}
}
function gd_open_state(force){
	var s=gd_state;
	if(s){
		if(!gd_issupported){
			gd_state='';
			alert("This browser does not support.");
			return;
		}
		s=decodeURIComponent(s);
		try{
			var a=JSON.parse(s);
			var ids=[];
			function find(b){
				if(!b)return;
				for(var i=0; i <= b.length-1; i++){
					if(b[i]){
						var cc={};
						cc.id=b[i];
						ids.push(cc);
					}
				}
			}
			find(a.ids);
			find(a.exportIds);
			if(ids.length>0){
				gd_login(function(result){
					if(gd_open2 && !force)return;
					gd_open2=true;
					if(!result)return;				
					//_getid('gd_btn_reopen').style.display='';
					gd_state='';
					gd_loadfiles(ids,true);
				});				
			}
		}catch(err){
		}
	}
}
var gd_open2;
function gd_open_state2(){
	setTimeout(function(){
		if(!gd_open2)gd_open_state();
	}, 1000);
}
function gd_clientload(){
	gd_loaded=true;
	if (window.addEventListener){
		window.addEventListener("resize", gd_btn_login2, false);
	}else if (window.attachEvent){
		window.attachEvent("onresize", gd_btn_login2);
	}
	gd_open_state();
}

function gd_loadscript(callback){
	function inject(s){
		var o = document.createElement('scri' + 'pt');
		o.setAttribute('src', s);
		o.setAttribute('type', 'text/javascript');
		document.body.appendChild(o);
	}
	if(gd_load_timer)return;
	if(gd_loaded && gd_pickerloaded)return;
	gd_load_timer=setInterval(function(){
		if(gd_loaded && gd_pickerloaded){
			clearInterval(gd_load_timer);
			if(callback) callback();
		}
	},100);
	inject('https://apis.google.com/js/client.js?onload=gd_clientload');
	inject('https://apis.google.com/js/api.js?onload=gd_loadpicker');	
}
function gd_reopen(){
	if(gd_state2){
		var m="";
		var s='?';
		if(m) s+='m='+m+'&';
		s+='state='+encodeURIComponent(gd_state2);
		location.href=s;
	}
}
function gd_dblclick(){
	function dblclick(){
		try{
			if(gd_picker)gd_picker.setVisible(false);
			if(gd_picker2)gd_picker2.setVisible(false);
		}catch(err){}
	}
	function keydown(e){
		if(!e)e=window.event;
		if(e && e.keyCode==27) dblclick();
	}
	if(window.addEventListener){
		document.addEventListener("dblclick", dblclick, false);
		document.addEventListener("keydown", keydown, false);
	}else if(window.attachEvent){
		document.attachEvent("ondblclick", dblclick);
		document.attachEvent("onkeydown", keydown);
	}
}
var gd_userId,gd_email;
function gd_weburl(){
	var s;
	if(gd_email) s='https://drive.google.com/?authuser='+encodeURIComponent(gd_email);
	else s='https://drive.google.com/';
	return s;
}
function gd_clickweburl(f){
	var s=f.href || '';
	var p1=s.indexOf('#');
	if(p1<0) s='';
	else s=s.substr(p1,s.length);
	f.href=gd_weburl()+s;
}
function gd_info(){
	if(gd_email)return;
	gapi.client.load('drive', 'v2', function(){
		var request = gapi.client.drive.about.get();
		request.execute(function(resp) {
			if(resp && resp.user){
				if(gd_email)return;
				gd_email=resp.user.emailAddress;
				if(gd_email){
					var a=_getid('btn_open');
					var b=_getid('gd_btn_reopen');
					if(a)a.title=a.title+' ('+gd_email+')';
					if(b)b.title=b.title+' ('+gd_email+')';
				}				
			}
		});
	});
}
window.URL=window.URL || window.webkitURL;
function gd_init(){
	gd_dblclick();
	gd_state2=gd_state;
	if(!window.XMLHttpRequest || !window.URL){//!window.FileReader 
	}else{
		gd_issupported=true;
		if(gd_state){
			try{
				var a=JSON.parse(gd_state);
				gd_userId=a.userId;
				if(a.ids || a.exportIds){
					_getid("downlink").innerHTML="<table><tr><td><div id='gd_progress'>Ready...</div></table>";
				}
			}catch(err){}			
			if(window.addEventListener) window.addEventListener("load", gd_open_state2, false);
			else if (window.attachEvent) window.attachEvent("onload", gd_open_state2);
		}
		gd_loadscript();
	}
}
var gopenwindow,htmlsourceopened;
function init_message(){
	function receiveMessage(e) {
		//console.log(e);
		var win=e.source || e.srcElement || e.target;
		if(!win || !e.origin){
			return;
		}
		if(!gopenwindow && e.data && e.data.type=='htmleditor'){
			gopenwindow={};
			gopenwindow.win=win;
			gopenwindow.origin=e.origin;
			gopenwindow.data=e.data;		
			gopenwindow.win.postMessage({type:'htmlsource'}, gopenwindow.origin);
		}else if(e.data.type=='htmlsource' && !htmlsourceopened){
			if(editor && editor.checkDirty()){				
				var answer=confirm("Received a request to load html data. Are you sure you want to load this data?");								
				if(!answer){
					htmlsourceopened=true;return;
				}
			}	
			var f=new Blob([e.data.data], {type: 'text/html'});
			f.name=e.data.name;			
			var resp={};
			resp.title=f.name;
			resp.fileSize=f.size;
			resp.mimeType='text/html';
			resp.islocal=true; //for saveas
			proc_read(f, resp);
			htmlsourceopened=true;
			if(gopenwindow && gopenwindow.win && gopenwindow.origin){
				gopenwindow.win.postMessage({type:'htmlsource_completed'}, gopenwindow.origin);			
			}
		}
	}
	window.addEventListener('message', receiveMessage);
}

var gtextboxcount=(new Date()).getTime();
var gtextboxid='_textbox20220124_';
var gtextboxscript=_getid('gtextboxscript_data').value;
var gtextboxadded=false;
var gtextboxscript_init_timer,gtimer1;
function _getfrmdoc(ifrm){
	return (ifrm.contentWindow) ? ifrm.contentWindow : (ifrm.contentDocument.document) ? ifrm.contentDocument.document : ifrm.contentDocument;
}
function gtextboxscript_init(){
	function go1(){
		if(!gtextboxadded)return;
		var a=document.getElementsByTagName('IFRAME');
		if(!a || a.length<=0)return;
		var ifrm;
		for(var i=0; i<a.length; i++){ 
			if(a[i].className && a[i].className.indexOf("cke_wysiwyg")>=0){
				try{ifrm=_getfrmdoc(a[i]);}catch(err){}; if(ifrm)break;
			}
		}		
		if(!ifrm || !ifrm.document)return;
		var doc=ifrm.document;
		var head = doc.head || doc.getElementsByTagName('head')[0];
		if(head){
			if(!ifrm._dragElement20220124_ || !ifrm._dragElement20220124_init_){
				var script=doc.createElement("script");
				script.type="text/javascript";
				script.setAttribute("data-cke-temp","1");		
				script.innerHTML=gtextboxscript;
				head.appendChild(script);
			}
			if(ifrm._dragElement20220124_init_) ifrm._dragElement20220124_init_();
		}
	}
	clearTimeout(gtextboxscript_init_timer);
	gtextboxscript_init_timer=setTimeout(go1,300);
}
function proc_prewview(edt, isnew){
	if(isnew) var win=window.open('');
	else var win=window.open('','htmleditor_preview');
	if(win) var doc=win.document;
	if(!win || !doc){
		alert('Error!!');
		return;
	}
	var s=edt.getData();
	if(gdata.baseHref) s='<base href="'+gdata.baseHref+'">'+s;
	doc.write(s);
	doc.close();
}

	CKEDITOR.on('instanceReady',function(ev){
		_getid('loading').style.display='none';
		proc_resize(true);
		setTimeout(function(){
			proc_resize(true);
		},1000);
		gd_init();
		init_message();
		var c=_getid('cke_15');
		if(c && c.title=='Source'){
			c.title='Source (Ctrl+Space: HTML Tag Autocomplete, Ctrl+Q: CodeFolding On/Off, Ctrl+L: LineWrapping On/Off)';
		}	
		ev.editor.on('dataReady',function(ev){
			//console.log('dataReady');
			gtextboxscript_init();
			clearTimeout(gtimer1); var k=0;
			gtimer1=setInterval(function(){
				k++; if(k>20) clearTimeout(gtimer1);
				if(editor && editor.mode=='wysiwyg'){
					clearTimeout(gtimer1);return;
				}
				if(editor && editor.getCommand){
					var a=editor.getCommand('myCommand12');
					if(a && a.state==0){						
						clearTimeout(gtimer1);a.enable();
					}
				}
			},500);
		});
		ev.editor.on('contentDom',function(ev){
			//console.log('contentDom');
			gtextboxscript_init();
		});
			});

	CKEDITOR.domReady(function(){
editor.addCommand("myCommand3",{
    exec: function(edt) {
		proc_prewview(edt, false);
    }
});
editor.ui.addButton('myButton3', { 
    label: "Preview, Print and Save to PDF (Open in the same window)",
    command: 'myCommand3',
    toolbar: 'mode,20',
    icon: 'https://iblogbox.github.io/js/htmleditor/images/viewmag.png'
});
editor.addCommand("myCommand4",{
    exec: function(edt) {
		proc_prewview(edt, true);
    }
});
editor.ui.addButton('myButton4', { 
    label: "Preview, Print and Save to PDF (Open in the new window)",
    command: 'myCommand4',
    toolbar: 'mode,30',
    icon: 'https://iblogbox.github.io/js/htmleditor/images/viewmag2.png'
});

editor.addCommand("myCommand5",{
exec: function(edt) {
	var s=gettitle(gdata.resp);
	var ext=getfileext(s) || 'html';
	s=getfilename(s) || getstorage('c_saveTo') || 'No_Title';
	_getid('saveTo').value=s;
	_getid('saveTo').setAttribute("data",ext);
	_getid('convertTo').value=getstorage('c_convertTo') || 'PdocPDF';
	_getid('pdforientation').value=getstorage('c_pdforientation') || 'Portrait';	
	_getid('convertTo').onchange();
	var a=_getid("gd_convertwindow");
	a.style.left="2px";
	a.style.top="2px";
	a.style.display='';	
}
});
editor.ui.addButton('myButton5', { 
    label: "Convert & Download As... and Save to Computer",
    command: 'myCommand5',
    toolbar: 'mode,40',
    icon: 'https://iblogbox.github.io/js/img/etc/urltodrive_logo65.png'
});

editor.addCommand("myCommand6",{
    exec: function(edt) {
		window.open('http://spellcheck.iblogbox.com/');
    }
});
editor.ui.addButton('myButton6', { 
    label: "Fresh Spell Checker (Free Online Spell Check)",
    command: 'myCommand6',
    toolbar: 'selection',
    icon: 'https://iblogbox.github.io/js/htmleditor/images/spellcheck16.png'
});
editor.addCommand("myCommand1",{
    exec: function(edt) {
		window.open('http://atomurl.net/qrcode/');
    }
});
editor.ui.addButton('myButton1', { 
    label: "QR Code Generator, Insert QR code image.",
    command: 'myCommand1',
    toolbar: 'others',
    icon: 'https://iblogbox.github.io/js/htmleditor/images/qrcode16.png'
});
editor.addCommand("myCommand2",{
    exec: function(edt) {
		window.open('http://atomurl.net/math/');
    }
});
editor.ui.addButton('myButton2', { 
    label: "TeX equation editor, Insert equation image.",
    command: 'myCommand2',
    toolbar: 'others',
    icon: 'https://iblogbox.github.io/js/htmleditor/images/math16.png'
});

//textbox
editor.addCommand("myCommand11",{
exec: function(edt){
	function getScrollLeft(doc){
		var scrollLeft;
		if(doc.body && doc.body.scrollLeft){
			scrollLeft = doc.body.scrollLeft;
		}else if(doc.documentElement && doc.documentElement.scrollLeft){
			scrollLeft = doc.documentElement.scrollLeft;
		}
		if(!scrollLeft) scrollLeft=0; return scrollLeft;
	}
	function getScrollTop(doc){
		var scrollTop;
		if(doc.body && doc.body.scrollTop){
			scrollTop = doc.body.scrollTop;
		}else if(doc.documentElement && doc.documentElement.scrollTop){
			scrollTop = doc.documentElement.scrollTop;
		}
		if(!scrollTop) scrollTop=0; return scrollTop;
	} 
	var a=document.getElementsByTagName('IFRAME');
	if(!a || a.length<=0){show_message('Error. Can not add a floating textbox.');return;}
	var ifrm;
	for(var i=0; i<a.length; i++){ 
		if(a[i].className && a[i].className.indexOf("cke_wysiwyg")>=0){
			try{ifrm=_getfrmdoc(a[i]);}catch(err){}; if(ifrm)break;
		}
	}		
	if(!ifrm || !ifrm.document || !ifrm.document.body){show_message('Error. Can not add a floating textbox.');return;}
	var doc=ifrm.document;	
	var sl=getScrollLeft(doc)+100;
	var st=getScrollTop(doc)+50;
	gtextboxcount++;
	var src='<div id="'+gtextboxid+gtextboxcount+'" style="position:absolute;left:'+sl+'px;top:'+st+'px;border:0px solid red;padding:10px"><span style="font-size:17px;font-family:Arial">Enter the text here (Mouse [MiddleClick] or ctrl/alt+[RightClick]: remove textbox)</span></div>';
	//z-index:100000000 --> table resize not work
	var head = doc.head || doc.getElementsByTagName('head')[0];
	if(head){
		var flag=gtextboxadded;
		gtextboxadded=true;
		doc.body.insertAdjacentHTML("beforeend",src);
		if(!ifrm._dragElement20220124_ || !ifrm._dragElement20220124_init_){
			var script=doc.createElement("script");
			script.type="text/javascript";
			script.setAttribute("data-cke-temp","1");		
			script.innerHTML=gtextboxscript;
			head.appendChild(script);
		}
		if(ifrm._dragElement20220124_) ifrm._dragElement20220124_(doc.getElementById(gtextboxid+gtextboxcount));
		if(!flag && ifrm._dragElement20220124_init_) ifrm._dragElement20220124_init_();		
	}else{
		show_message('Error. Can not add a floating textbox.');
	}
}
});
editor.ui.addButton('myButton11', { 
    label: "Add a floating textbox to a page (Mouse [MiddleClick] or ctrl/alt+[RightClick]: remove textbox)",
    command: 'myCommand11',
    toolbar: 'mode,31',
    icon: 'https://htmleditor.kwebpia.net/images/text_bold.png'
});
//textbox end
//help
editor.addCommand("myCommand12",{
exec: function(edt) {
	if(!_getid('help')){alert('No found a help data.');return;}
	var s=_getid('help').innerHTML;
	s='<table><tr><td>'+s+'<tr><td align=center><a href="#" onclick="hide_message();return false">Close</a></table>';
	show_message(s,'','','',1000*60*60*24);
}
});
editor.ui.addButton('myButton12', { 
    label: "help",
    command: 'myCommand12',
    toolbar: 'mode,41',
    icon: 'https://htmleditor.kwebpia.net/images/help.png'
});

	});	
	
	CKEDITOR.config.codemirror = {
		matchBrackets:false,autoCloseTags: true,autoCloseBrackets: false,
		autoFormatOnStart:false,autoFormatOnModeChange:false,autoFormatOnUncomment:false,
		showSearchButton:false,showTrailingSpace:false,highlightMatches:false,
		showFormatButton:false,showCommentButton:false,showUncommentButton:false,showAutoCompleteButton:true,enableCodeFormatting:true,
		styleActiveLine:false,matchTags:false,lineWrapping:true,dragDrop:false
	};
	CKEDITOR.config.baseHref=gbaseurl;
	CKEDITOR.plugins.addExternal('osem_googlemaps', 'https://htmleditor.kwebpia.net/js/ckeditor/plugins/osem_googlemaps/plugin.js');			
	CKEDITOR.plugins.addExternal('youtube', 'https://htmleditor.kwebpia.net/js/ckeditor/plugins/youtube/plugin.js');			
	CKEDITOR.plugins.addExternal('oembed', 'https://htmleditor.kwebpia.net/js/ckeditor/plugins/oembed/plugin.js');						
	//CKEDITOR.plugins.addExternal('codemirror', 'https://htmleditor.kwebpia.net/js/ckeditor/plugins/codemirror/plugin.js');		
	CKEDITOR.plugins.addExternal('codemirror', 'https://iblogbox.github.io/js/htmleditor/codemirror/plugin.js');	
	CKEDITOR.plugins.addExternal('image2', 'https://htmleditor.kwebpia.net/js/ckeditor/plugins/image2/plugin.js?t=4');
	var ss='8/8px;9/9px;10/10px;11/11px;';
	for(var i=12; i<=99; i++){    
		if(i<=40 && i%2==0) ss+=i+'/'+i+'px;';
		else if(i>40 && i%4==0) ss+=i+'/'+i+'px;';
	}
	CKEDITOR.config.fontSize_sizes=ss;

	var editor=CKEDITOR.replace( 'editor1', {
		language: 'en',
		extraPlugins: 'colordialog,tableresize,wysiwygarea,image2,osem_googlemaps,youtube,oembed,codemirror', //placeholder
		removePlugins: 'preview,wsc', //elementspath,save,font,scayt
		//resize_enabled: false,
		resize_dir: 'horizontal', //both
		removeButtons: 'Save,Maximize,About',
		//toolbar: [[ 'Source', '-', 'Bold', 'Italic' ]],
		width: 200, height: 300,
		fullPage: true, allowedContent: true, enterMode: CKEDITOR.ENTER_BR
	});			
			

var u_uploading,gsaveblob;
function proc_convert(issave){	
	if(gadb){alert('Please disable the adblock for free use.');return;}	var issafari=false;
	var ua = navigator.userAgent.toLowerCase(); 
	if (ua.indexOf('safari') != -1 && ua.indexOf('chrome') <0){ 
		issafari=true;
	}
	function guid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0,a=d=="x"?b:(b&3|8);return a.toString(16)})};
	function g(f,b){var d={};try{try{d=JSON.parse(getstorage(b))}catch(c){d={}}if(!d){d={}}var a=new Date();var e=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate();if(d.time!=e){d.time=e;d.count=1}else{if(!d.count){d.count=1}d.count=d.count+1}if(f){setstorage(b,JSON.stringify(d))}}catch(c){}return d};
	
	if(u_uploading){alert("It's uploading. Please try again later. or Cancel the current job.");return;}
	var uid=getstorage('c_uniq');
	if(!uid){
		uid=guid().replace(/-/g,'').substr(0,10);
		setstorage('c_uniq',uid);
	}		
	var texts=editor.getData();
	var saveTo=trim(_getid('saveTo').value);

	if(issave){
		if(!texts){alert('No html to be saved.');return;}	
		if(!saveTo){alert('Please enter a filename to be saved.');_getid('saveTo').focus();return;}	
		setstorage('c_saveTo',saveTo);		

		var ext=_getid('saveTo').getAttribute("data");
		var filename=saveTo;
		var blob = new Blob([replace_charset(texts)], {encoding:"UTF-8",type:"text/html;charset=UTF-8"});
		if(navigator.msSaveBlob){
			navigator.msSaveBlob(blob, filename+'.'+ext);
		}else{
			if(!window.URL){
				alert("This browser does not support.");
				return;
			}
			var blobLink=_getid('btn_save2_link');
			blobLink.href='javascript:void(0);';
			blobLink.download = filename+'.'+ext;
			if(gsaveblob) window.URL.revokeObjectURL(gsaveblob);
			gsaveblob=window.URL.createObjectURL(blob);
			if(issafari){
				window.open(gsaveblob);
			}else{
				blobLink.target='_blank';
				blobLink.href=gsaveblob;
			}
		}
		return;
	}

	if(!texts){alert('No html to be converted.');return;}	
	if(texts.length>3*1024*1024){
		alert('The html size is too large to convert. (3 MB limit)');return;
	}
	if(!saveTo){alert('Please enter a filename to be converted.');_getid('saveTo').focus();return;}	
	setstorage('c_saveTo',saveTo);		
	texts=replace_charset(texts,true);
	var saveTo2=saveTo;
	if(saveTo2=='No_Title') saveTo2=saveTo2+'_'+uid;

	function end(){
		u_uploading=false;
		_getid("umsg1").innerHTML='';
	}

	if(u_uploading)return;u_uploading=true;
	var udata=g(false,'iwcount');			
	if(udata.count>20){alert('You have exceeded the daily usage for conversion. Please try again later.');return;} 
	setstorage('iwcount', JSON.stringify(udata));

	_getid("umsg1").innerHTML="<table><tr><td><div id='u_progress'>Uploading...</div><td>&nbsp;<a href='#' id='u_cancel' style='font-size:14px;display:none'>Cancel</a></table>";
	try{
		var xhr = new XMLHttpRequest();
		var canceled;
		var c=_getid('u_cancel');
		if(c){
			c.style.display='';
			c.onclick=function(){
				canceled=true;
				xhr.abort(); 							
				end();
				return false;
			}
		}
		var starttime=(new Date()).getTime();
		var u_lastprogress=(new Date()).getTime();		
		var convertTo=_getid('convertTo').value || 'PdocPDF';
		var timeout=38;
		var fd = new FormData();  
		fd.append('uid', uid);
		fd.append('originalFormat', 'PdocHTML');		
		fd.append('convertTo', convertTo);
		fd.append('texts', texts);
		fd.append('saveTo', saveTo2);		
		fd.append('pdfzoom','0.83');	
		fd.append('timeout', timeout);	
		fd.append('pdforientation', _getid('pdforientation').value);		
				var uploadurl='https://htmtopdf.herokuapp.com/docconvert/run.php';		
		function _result(){
			var error,checked;
			if(xhr.status == 200){
				var a={};
				try{a=JSON.parse(xhr.response);}catch(err){a={};}
				checked=a.checked;
				if(a.error && a.error[0]){
					end();
					alert(a.error[0]);
					return;
				}else if(a.pdfname){
					end();
					var ext=getfileext(a.pdfname);
					var link=a.pdfname+'?t='+(new Date()).getTime();
					var s='Completed ('+ext.toUpperCase()+'). <a id="udownlink" href="'+link+'" download="" target="_blank" style="font-size:15px">Download</a>';
					if(ext=='pdf') s+=' &nbsp;<a href="'+link+'" target="_blank" title="View a file in new window">View</a>';
					_getid("umsg1").innerHTML=s;
					var c=_getid("udownlink");
					if(c) c.download=saveTo+"."+ext;
					return;
				}else{
					error='Unknown Error.';
				}
			}else{
				error="Error (status) " + xhr.status + "("+xhr.statusText+") occurred while uploading the file.";
			}			
			return {'error':error, 'checked':checked};
		}
		var checkcount=0;
		function _checkcomplete(){
			if(canceled)return;
			var fd = new FormData();  
			fd.append('uid', uid);
			fd.append('originalFormat', 'PdocHTML');		
			fd.append('convertTo', convertTo);
			fd.append('texts', "texts");
			fd.append('saveTo', saveTo2);		
			xhr.upload.onprogress=function(){};
			xhr.open('POST', uploadurl+'?checkcomplete=1', true); 		  
			xhr.onload=function() {
				if(canceled)return;				
				var a=_result();
				if(a && a.error){
					if(a.error=='Unknown Error.' || a.checked=='ok'){
						_checkcomplete2();
					}else{
						end();
						alert(a.error);
					}
				}
			}
			xhr.onerror=function(e){
				if(canceled)return;
				end();
				alert("Error " + e.target.status + " occurred while uploading the file.");			
			}
			xhr.send(fd);	
		}
		function _checkcomplete2(){
			var interval=3;
			if(checkcount>(timeout/interval)){
				alert('Converting Failed. Timeout. It seems to be too large size to process.');
				return;
			}
			checkcount++;			
			xhr.abort();
			setTimeout(function(){
				_checkcomplete();
			}, interval*1000);
		}

		xhr.upload.onprogress = function(e) {
			if(u_lastprogress){
				var elaspetime = new Date();
				var dt=(elaspetime.getTime()-u_lastprogress);
				if(dt<300)return;
				u_lastprogress=elaspetime.getTime();
			}
			if(!e.lengthComputable)return;
			var percentComplete = (e.loaded / e.total) * 100;
			percentComplete=Math.floor(percentComplete);
			if(percentComplete>=100) percentComplete=100;

			var s=percentComplete+"% Done.";
			if(percentComplete>80) s="Converting.. Please wait...";
			var c=_getid('u_progress');
			if(c) c.innerHTML=s;
		}
		xhr.open('POST', uploadurl, true); 		
		xhr.onload=function() {
			if(canceled)return;			
			var c=_getid('u_cancel'); if(c) c.style.display='none';
			var a=_result();
			if(a && a.error){
				if(a.error=='Unknown Error.' || a.checked=='ok'){				
					var c=_getid('u_progress'); if(c) c.innerHTML="Converting.. Please wait...";
					_checkcomplete2();
				}else{
					end();
					alert(a.error);
				}
			}
		}
		xhr.onerror=function(e){
			if(canceled)return;
			end();
			alert("Error " + e.target.status + " occurred while uploading the file.");			
		}
		xhr.send(fd);	
  }catch(err){
	end();
	alert(err+'\n\nor This browser does not support. Please upgrade your browser.');
  }
}
</script>

<div id="gd_convertwindow" class="gd_div" style="z-index:101;display:none;padding:10px">
<table style="white-space:nowrap">
<tr><td>Convert to<td><select id="convertTo" onchange="setstorage('c_convertTo',this.value);if(this.value=='PdocPDF') _getid('pdforientation').disabled=false;else _getid('pdforientation').disabled=true;" style="width:120px">
<option value="PdocPDF">PDF<option value="PdocDOCX">DOCX<option value="PdocODT">ODT<option value="PdocEPUB">EPUB<option value="PdocMOBI">MOBI<option value="PdocRTF">RTF (Word DOC)<option value="PdocMD">MD (Markdown)<option value="PdocTEX">TEX (LaTex Article)
</select> &nbsp;(free OO converts/1 Day)
<tr><td>Filename<td><input type=text id="saveTo" style="width:280px">
<tr><td>PDF Orientation<td><select id="pdforientation" onchange="setstorage('c_pdforientation',this.value)" style="width:120px" disabled=true>
<option value="Portrait">Portrait
<option value="Landscape">Landscape
</select>
<tr><td colspan=2 align=center>
	<div id="umsg1" style="margin-bottom:5px;"></div>
	<button style="" class=middle onclick="proc_convert()">Convert & Download As...</button>
	<a href="javascript:void(0);" id="btn_save2_link"><button style="" class=middle onclick="proc_convert(true)">Save as HTML</button></a>
<tr><td>
<tr><td colspan=2 align=center>
	<button onclick="_getid('gd_convertwindow').style.display='none';"><img src="images/close.png" align="absmiddle"> Close</button>
</table>
</div>

<style>
.cke_chrome{
	-moz-box-shadow: 0 0 0px rgba(0,0,0,.15);
	-webkit-box-shadow: 0 0 0px rgba(0,0,0,.15);
	box-shadow: 0 0 0px rgba(0,0,0,.15);
}
.CodeMirror{
	font-family:monospace;font-size:13px;
}
.cke_combopanel__fontsize{
	width:145px !important;
}
</style>

<script src="https://storage.googleapis.com/app0126/js/compat2.js"></script>
<script>init_compat201912_a();</script>
<script>
function gd_findscope(a){try{if(!a)return!1;a=" "+a.toLowerCase()+" ";var b=SCOPES;SCOPES.split&&"string"===typeof SCOPES&&(b=SCOPES.split(" "));for(var c=0;c<b.length;c++)if(b[c]){var d=(b[c].split("/").pop().toLowerCase()||"").replace(/^\s*|\s*$/g,"");"drive.appfolder"==d&&(d="drive.appdata");if(/^(drive\.install|drive\.file|drive|drive\.readonly|drive\.appdata|drive\.appfolder|documents|spreadsheets|script\.external_request|calendar|gmail\.send|gmail\.compose|gmail\.readonly|youtube|books|drive\.activity\.readonly|drive\.activity|drive\.apps\.readonly|drive\.metadata|drive\.metadata\.readonly|drive\.scripts)$/.test(d)&&
0>a.indexOf(d+" "))return!1}}catch(e){}return!0}
function init_fix_scope(){var a=window.gd_login_manual,b=window.gd_login;a||(a=window.proc_login_manual);b||(b=window.proc_login);a&&(a+="");b&&(b+="");a&&0<=a.indexOf("if (authResult && !authResult.error")&&0>a.indexOf("gd_findscope(")?(a=a.replace("if (authResult && !authResult.error","if (authResult && !authResult.error && gd_findscope(authResult.scope)"),window.eval(a)):a&&0<=a.indexOf("if (authResult && (!authResult.error || authResult.access_token)")&&0>a.indexOf("gd_findscope(")&&(a=a.replace("if (authResult && (!authResult.error || authResult.access_token)",
"if (authResult && (!authResult.error || authResult.access_token) && gd_findscope(authResult.scope)"),window.eval(a));b&&0<=b.indexOf("if (authResult && !authResult.error")&&0>b.indexOf("gd_findscope(")?(b=b.replace("if (authResult && !authResult.error","if (authResult && !authResult.error && gd_findscope(authResult.scope)"),window.eval(b)):b&&0<=b.indexOf("if (authResult && (!authResult.error || authResult.access_token)")&&0>b.indexOf("gd_findscope(")&&(b=b.replace("if (authResult && (!authResult.error || authResult.access_token)",
"if (authResult && (!authResult.error || authResult.access_token) && gd_findscope(authResult.scope)"),window.eval(b))}init_fix_scope();
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"66ac12690e504a55bb93e55864b049b3","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
