<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>テトリス</title>
<style>
  body{
    margin:0;
    background:#0b0f1a;
    color:#fff;
    font-family:system-ui, sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .game{
    display:flex;
    gap:20px;
    align-items:flex-start;
  }
  canvas{
    background:#111;
    border-radius:8px;
    box-shadow:0 0 25px rgba(0,255,255,.25);
  }
  .info{
    font-size:16px;
  }
  .info h1{
    margin:0 0 10px;
    font-size:20px;
  }

  .controls {
    margin-top:20px;
    display:grid;
    grid-template-columns:60px 60px 60px;
    gap:10px;
    justify-content:center;
  }
  .btn {
    width:60px;
    height:60px;
    background:#333;
    border-radius:10px;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:24px;
    border:2px solid #0f0;
    user-select:none;
  }
  .btn:active {
    background:#0f0;
    color:black;
  }

/* フローティングボタンの共通デザイン */
.floating-btn{
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    background: #111;
    border: 2px solid #4da6ff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 26px;
    color: #bcdfff;
    cursor: pointer;
    transition: 0.25s;
    box-shadow: 0 0 10px #3d8cff88;
}
/* ホバー時に光る */
.floating-btn:hover{
    background: #4da6ff33;
    box-shadow: 0 0 16px #4da6ffcc;
}
/* クリック時に縮む */
.floating-btn:active{
    transform: scale(0.9);
}
/* ボタン位置調整 */
#reloadBtn{
    bottom: 90px; /* logout の上に配置 */
}
#logoutBtn{
    bottom: 20px;
}
</style>
</head>
<body>

<div class="game">
  <canvas id="game" width="240" height="400"></canvas>
  <div class="info">
    <h1>テトリス</h1>
    <p>スコア: <span id="score">0</span></p>
    <p>
      ← → : 移動<br>
      ↓ : ソフトドロップ<br>
      ↑ : 回転<br>
      Space : ハードドロップ
    </p>
  </div>
</div>

<div class="controls">
  <div></div>
  <div class="btn" data-dir="up">▲</div>
  <div></div>
  <div class="btn" data-dir="left">◀</div>
  <div class="btn" data-dir="spa">●</div>
  <div class="btn" data-dir="right">▶</div>
  <div></div>
  <div class="btn" data-dir="down">▼</div>
  <div></div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");

const COLS = 10;
const ROWS = 20;
const BLOCK = 20;

canvas.width = COLS * BLOCK;
canvas.height = ROWS * BLOCK;

const COLORS = [
  null,
  "#00f0f0", // I
  "#0000f0", // J
  "#f0a000", // L
  "#f0f000", // O
  "#00f000", // S
  "#a000f0", // T
  "#f00000"  // Z
];

const SHAPES = [
  [],
  [[1,1,1,1]],
  [[2,0,0],[2,2,2]],
  [[0,0,3],[3,3,3]],
  [[4,4],[4,4]],
  [[0,5,5],[5,5,0]],
  [[0,6,0],[6,6,6]],
  [[7,7,0],[0,7,7]]
];

let board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
let score = 0;

let player = {
  x:0,
  y:0,
  matrix:null
};

function drawBlock(x,y,val){
  ctx.fillStyle = COLORS[val];
  ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK-1,BLOCK-1);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  board.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v) drawBlock(x,y,v);
    });
  });

  player.matrix.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v) drawBlock(player.x+x, player.y+y, v);
    });
  });
}

function collide(){
  return player.matrix.some((row,y)=>
    row.some((v,x)=>{
      if(!v) return false;
      const px = player.x + x;
      const py = player.y + y;
      return py>=ROWS || px<0 || px>=COLS || board[py][px];
    })
  );
}

function merge(){
  player.matrix.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v) board[player.y+y][player.x+x] = v;
    });
  });
}

function rotate(mat){
  return mat[0].map((_,i)=>mat.map(r=>r[i]).reverse());
}

function clearLines(){
  outer: for(let y=ROWS-1;y>=0;y--){
    if(board[y].every(v=>v)){
      board.splice(y,1);
      board.unshift(Array(COLS).fill(0));
      score += 100;
      y++;
    }
  }
  scoreEl.textContent = score;
}

function drop(){
  player.y++;
  if(collide()){
    player.y--;
    merge();
    clearLines();
    resetPlayer();
    if(collide()){
      alert("GAME OVER\nScore: "+score);
      board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
      score = 0;
      scoreEl.textContent = score;
    }
  }
}

function hardDrop(){
  while(!collide()){
    player.y++;
  }
  player.y--;
  merge();
  clearLines();
  resetPlayer();
}

function resetPlayer(){
  const type = Math.floor(Math.random()*7)+1;
  player.matrix = SHAPES[type];
  player.y = 0;
  player.x = (COLS/2|0) - (player.matrix[0].length/2|0);
}

let dropCounter = 0;
let dropInterval = 500;
let lastTime = 0;

function update(time=0){
  const delta = time - lastTime;
  lastTime = time;
  dropCounter += delta;
  if(dropCounter > dropInterval){
    drop();
    dropCounter = 0;
  }
  draw();
  requestAnimationFrame(update);
}

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft"){player.x--; if(collide()) player.x++;}
  if(e.key==="ArrowRight"){player.x++; if(collide()) player.x--;}
  if(e.key==="ArrowDown"){drop();}
  if(e.key==="ArrowUp"){
    const old = player.matrix;
    player.matrix = rotate(player.matrix);
    if(collide()) player.matrix = old;
  }
  if(e.code==="Space") hardDrop();
});

// スマホボタン
document.querySelectorAll(".btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const dir = btn.dataset.dir;
    if(dir==="up"){
    const old = player.matrix;
    player.matrix = rotate(player.matrix);
    if(collide()) player.matrix = old;
  }
    if(dir==="down"){drop();}
    if(dir==="left"){player.x--; if(collide()) player.x++;}
    if(dir==="right"){player.x++; if(collide()) player.x--;}
    if(dir==="spa"){hardDrop();}
  });
});

resetPlayer();
update();
</script>
<div id="reloadBtn" class="floating-btn" onclick="reload()">↻</div>
<div id="logoutBtn" class="floating-btn" onclick="backPage()">⇦</div>
</body>
    <script>
        const urlParams = new URLSearchParams(location.search);
        const token1 = urlParams.get("key1");
        const token3 = localStorage.getItem("account1");
        localStorage.setItem("account1", "");
        if((token1 !== localStorage.getItem("key1")) || (token3 == "") || (token3 == null)){
            localStorage.setItem("key1", "unauthorized");
            localStorage.setItem("requestPage1", "page0011");
            location.href = "https://wakaruwakaru.github.io/game-sites/";
        }else{
            localStorage.setItem("requestPage1", "");
            localStorage.setItem("key1", "");
        }

        function reload(){
            const key1 = crypto.randomUUID();
            localStorage.setItem("key1", key1);
            localStorage.setItem("account1", token3);
            location.href = "https://wakaruwakaru.github.io/game-sites/page0011?key1=" + key1;
        }
        function backPage(){
            const key1 = crypto.randomUUID();
            localStorage.setItem("key1", key1);
            localStorage.setItem("account1", token3);
            location.href = "https://wakaruwakaru.github.io/game-sites/top0001?key1=" + key1;
        }
    </script>
</html>
