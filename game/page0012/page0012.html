<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>マージ2048</title>
<style>
body{
  margin:0;
  background:#0b0f1a;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  font-family:system-ui;
  user-select:none;
}
.game{
  background:#111;
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 30px #00ffff55;
}
.grid{
  display:grid;
  grid-template-columns:repeat(4,80px);
  grid-template-rows:repeat(4,80px);
  gap:10px;
  background:#222;
  padding:10px;
  border-radius:12px;
  touch-action:none;
}
.cell{
  background:#333;
  border-radius:10px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  font-weight:bold;
  color:white;
}
.v2{background:#eee;color:#222}
.v4{background:#ddd}
.v8{background:#f0a}
.v16{background:#f90}
.v32{background:#f60}
.v64{background:#f30}
.v128{background:#0ff;color:#000}
.v256{background:#0f0;color:#000}
.v512{background:#ff0;color:#000}
.v1024{background:#f0f}
.v2048{background:#0ff;box-shadow:0 0 20px #0ff}

/* フローティングボタンの共通デザイン */
.floating-btn{
    position: fixed;
    right: 10px;
    bottom: 10px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #111;
    border: 2px solid #4da6ff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 26px;
    color: #bcdfff;
    cursor: pointer;
    transition: 0.25s;
    box-shadow: 0 0 10px #3d8cff88;
}
/* ホバー時に光る */
.floating-btn:hover{
    background: #4da6ff33;
    box-shadow: 0 0 16px #4da6ffcc;
}
/* クリック時に縮む */
.floating-btn:active{
    transform: scale(0.9);
}
/* ボタン位置調整 */
#reloadBtn{
    bottom: 75px; /* logout の上に配置 */
}
#logoutBtn{
    bottom: 20px;
}
</style>
</head>
<body>

<div class="game">
  <div class="grid" id="grid"></div>
</div>

<div id="reloadBtn" class="floating-btn" onclick="reload()">↻</div>
<div id="logoutBtn" class="floating-btn" onclick="backPage()">⇦</div>
<script>
const grid = document.getElementById("grid");
let board = Array(4).fill().map(()=>Array(4).fill(0));

function addRandom(){
  let empty=[];
  for(let y=0;y<4;y++){
    for(let x=0;x<4;x++){
      if(board[y][x]==0) empty.push({x,y});
    }
  }
  if(empty.length==0) return;
  const {x,y} = empty[Math.floor(Math.random()*empty.length)];
  board[y][x] = Math.random()<0.9?2:4;
}

function draw(){
  grid.innerHTML="";
  for(let y=0;y<4;y++){
    for(let x=0;x<4;x++){
      const v=board[y][x];
      const d=document.createElement("div");
      d.className="cell";
      if(v){
        d.textContent=v;
        d.classList.add("v"+v);
      }
      grid.appendChild(d);
    }
  }
}

function slide(row){
  row = row.filter(v=>v);
  for(let i=0;i<row.length-1;i++){
    if(row[i]==row[i+1]){
      row[i]*=2;
      row[i+1]=0;
    }
  }
  return row.filter(v=>v);
}

function move(dir){
  let moved=false;
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++){
      if(dir=="left"||dir=="right")
        line.push(board[i][dir=="left"?j:3-j]);
      else
        line.push(board[dir=="up"?j:3-j][i]);
    }
    let merged=slide(line);
    while(merged.length<4) merged.push(0);

    for(let j=0;j<4;j++){
      let v = merged[j];
      let y = (dir=="up"?j:dir=="down"?3-j:i);
      let x = (dir=="left"?j:dir=="right"?3-j:i);
      if(board[y][x]!=v){
        board[y][x]=v;
        moved=true;
      }
    }
  }
  if(moved){
    addRandom();
    draw();
  }
}

addRandom();
addRandom();
draw();

// keyboard
document.addEventListener("keydown",e=>{
  if(e.key=="ArrowLeft") move("left");
  if(e.key=="ArrowRight") move("right");
  if(e.key=="ArrowUp") move("up");
  if(e.key=="ArrowDown") move("down");
});

// swipe
let sx=0,sy=0;
grid.addEventListener("touchstart",e=>{
  sx=e.touches[0].clientX;
  sy=e.touches[0].clientY;
});
grid.addEventListener("touchend",e=>{
  let dx=e.changedTouches[0].clientX-sx;
  let dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30) move("right");
    if(dx<-30) move("left");
  }else{
    if(dy>30) move("down");
    if(dy<-30) move("up");
  }
});
</script>
    <script>
        const urlParams = new URLSearchParams(location.search);
        const token1 = urlParams.get("key1");
        const token3 = localStorage.getItem("account1");
        localStorage.setItem("account1", "");
        if((token1 !== localStorage.getItem("key1")) || (token3 == "") || (token3 == null)){
            localStorage.setItem("key1", "unauthorized");
            localStorage.setItem("requestPage1", "game/page0012/page0012");
            location.href = "/game-sites/";
        }else{
            localStorage.setItem("requestPage1", "");
            localStorage.setItem("key1", "");
            setInterval(() => {
                sendToGAS(token3, "", "page");
            }, 5000);
        }

    /* ======== Google Apps Script Web App URL ======== */
    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycbxzPIpMXRgQ5QuKM_hwIQ815at4Ml6Vvqhx_zabeDNGupPwsTvWWP3jpOXLnxbeGSIMDQ/exec";
    /* ======== GASに送信する処理 ======== */
    async function sendToGAS(User, text, status){
      const payload = {
        user: User,
        message: text,
        status
      };
      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",   // ← GAS が CORS 許可してないため必要
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.error("送信エラー:", e);
      }
    }

        function reload(){
            const key1 = crypto.randomUUID();
            localStorage.setItem("key1", key1);
            localStorage.setItem("account1", token3);
            location.href = "/game-sites/game/page0012/page0012?key1=" + key1;
        }
        function backPage(){
            const key1 = crypto.randomUUID();
            localStorage.setItem("key1", key1);
            localStorage.setItem("account1", token3);
            location.href = "/game-sites/top/top0001/top0001?key1=" + key1;
        }
    </script>
</body>
</html>
