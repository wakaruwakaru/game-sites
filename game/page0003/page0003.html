<html>
	<head>
		<TITLE>オセロ</TITLE>
		<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8" />
		<META NAME=viewport CONTENT="width=device-width, initial-scale=1" />
		<link rel="shortcut icon" href="/game-sites/index/icon/icon1.png" >
		<link rel="stylesheet" href="./css/main.css">
		<script>
mp = null;   // MainPanel 繧ｪ繝悶ず繧ｧ繧ｯ繝

			//
			// MainPanel 縺ｮ髢句ｧ
			//
function mp_start()
{
					// 繧ｭ繝｣繝ｳ繝舌せ諠ｱ
	let canvas = document.getElementById('canvas_e');   // 繧ｭ繝｣繝ｳ繝舌せ隕∫ｴ縺ｮ蜿門ｾ
	let ctx    = canvas.getContext('2d');   // 繧ｭ繝｣繝ｳ繝舌せ縺九ｉ繧ｳ繝ｳ繝く繧ｹ繝医ｒ蜿門ｾ
					// MainPanel 繧ｪ繝悶ず繧ｧ繧ｯ繝
	mp = new MainPanel(canvas, ctx);
					// StartPanel 縺ｮ陦ｨ遉ｺ
	st_start();
}
			//
			// MainPanel 繧ｪ繝悶ず繧ｧ繧ｯ繝茨ｼ医繝ｭ繝代ユ繧｣
			//
function MainPanel(canvas, ctx)
{
	this.canvas = canvas;   // 繧ｭ繝｣繝ｳ繝舌せ隕∫ｴ
	this.ctx    = ctx;   // 繧ｭ繝｣繝ｳ繝舌せ縺ｮ繧ｳ繝ｳ繝く繧ｹ繝
	this.method = 0;   // 繧ｲ繝ｼ繝譁ｹ豕包ｼ0:蟇ｾ莠ｺ髢難ｼ1:蟇ｾPC亥謇具ｼ会ｼ2:蟇ｾPC亥ｾ梧焔会ｼ
	return this;
}
			//
			// MainPanel 繧ｪ繝悶ず繧ｧ繧ｯ繝茨ｼ医Γ繧ｽ繝ラ
			//
MainPanel.prototype.finish = function()
{
					// 繧ｭ繝｣繝ｳ繝舌せ縺ｮ繧ｯ繝ｪ繧｢
	mp.ctx.clearRect(0, 0, mp.canvas.width, mp.canvas.height);
					// 繝懊ち繝ｳ繧帝撼陦ｨ遉ｺ
	document.getElementById('method').style.display = "none";
	document.getElementById('g_method0').style.display = "none";
	document.getElementById('g_method1').style.display = "none";
	document.getElementById('g_method2').style.display = "none";
	document.getElementById('ta').style.display = "none";
	document.getElementById('first').style.display = "none";
	document.getElementById('finish').style.display = "none";
}
      </script>
		<script>
			// StartPanel 縺ｮ髢句ｧ
			//
function st_start()
{
	mp.level = 1;   // 繧ｲ繝ｼ繝繝ｬ繝吶Ν縺ｮ險ｭ螳
					// 繧ｭ繝｣繝ｳ繝舌せ縺ｮ繧ｯ繝ｪ繧｢
	mp.ctx.clearRect(0, 0, mp.canvas.width, mp.canvas.height);
					// 繧ｲ繝ｼ繝繧ｿ繧､繝医Ν縺ｮ陦ｨ遉ｺ
	mp.ctx.font = "40px 'ｭｳ 繧ｴ繧ｷ繝け'";
	mp.ctx.textBaseline = "middle";
	mp.ctx.textAlign = "center";
	mp.ctx.fillStyle = "rgb(0, 0, 0)";
	mp.ctx.fillText("othello", mp.canvas.width/2, mp.canvas.height/2);
					// 繝懊ち繝ｳ縺ｮ陦ｨ遉ｺ蛻ｶ蠕｡
	document.getElementById('method').style.display = "";
	document.getElementById('g_method0').style.display = "";
	document.getElementById('g_method1').style.display = "";
	document.getElementById('g_method2').style.display = "";
	document.getElementById('ta').style.display = "none";
	document.getElementById('first').style.display = "none";
	document.getElementById('finish').style.display = "none";
}
      </script>
		<script>
gp = null;   // GamePanel 繧ｪ繝悶ず繧ｧ繧ｯ繝

			//
			// GamePanel 縺ｮ髢句ｧ
			//
function gp_start()
{
					// GamePanel 繧ｪ繝悶ず繧ｧ繧ｯ繝
	gp = new GamePanel();
					// 謠冗判
	gp.draw();
					// 繝槭え繧ｹ繧ｯ繝ｪ繝け縺ｫ蟇ｾ縺吶ｋ繧､繝吶Φ繝医Μ繧ｹ繝
	mp.canvas.addEventListener("click", gp.mouseClick);
					// 繝懊ち繝ｳ縺ｮ陦ｨ遉ｺ蛻ｶ蠕｡
	document.getElementById('method').style.display = "none";
	document.getElementById('g_method0').style.display = "none";
	document.getElementById('g_method1').style.display = "none";
	document.getElementById('g_method2').style.display = "none";
	document.getElementById('ta').style.display = "";
	document.getElementById('ta').style.color = "black";
	if (mp.method == 0)
		document.getElementById('ta').innerHTML = "黒の番です";
	else if (mp.method == 1)
		document.getElementById('ta').innerHTML = "あなた(黒)の番です";
	else
		document.getElementById('ta').innerHTML = "コンピューターの番です";
	document.getElementById('first').style.display = "";
	document.getElementById('finish').style.display = "";
					// 繧ｳ繝ｳ繝斐Η繝ｼ繧ｿ縺ｮ謫堺ｽ
	if (mp.method == 2) {
		let k = gp.computer();   // 繧ｳ繝槭ｒ鄂ｮ縺丞ｴ謇縺ｮ豎ｺ螳
		gp.set(k);   // 繧ｳ繝槭ｒ鄂ｮ縺
	}
}
			//
			// GamePanel 繧ｪ繝悶ず繧ｧ繧ｯ繝茨ｼ医繝ｭ繝代ユ繧｣
			//
function GamePanel()
{
	this.sz = 51;   // 繝槭せ逶ｮ縺ｮ螟ｧ縺阪＆
	this.gap = 3;   // 繝槭せ逶ｮ髢薙繧ｮ繝｣繝
	this.b_w = -1;   // -1:鮟偵謇狗分1:逋ｽ縺ｮ謇狗分
	this.st = new Array();   // 逶､髱｢縺ｮ迥ｶ諷具ｼ0:繧ｳ繝槭′鄂ｮ縺九ｌ縺ｦ縺ｪ縺ｼ-1:鮟抵ｼ1:逋ｽ
	this.st[0] = new Array(0, 0, 0, 0, 0, 0, 0, 0);
	this.st[1] = new Array(0, 0, 0, 0, 0, 0, 0, 0);
	this.st[2] = new Array(0, 0, 0, 0, 0, 0, 0, 0);
	this.st[3] = new Array(0, 0, 0, 1, -1, 0, 0, 0);
	this.st[4] = new Array(0, 0, 0, -1, 1, 0, 0, 0);
	this.st[5] = new Array(0, 0, 0, 0, 0, 0, 0, 0);
	this.st[6] = new Array(0, 0, 0, 0, 0, 0, 0, 0);
	this.st[7] = new Array(0, 0, 0, 0, 0, 0, 0, 0);
	this.n = new Array();   // 謖ｮ壹＆繧後◆菴咲ｽｮ縺ｮ蜷婿蜷代↓蟇ｾ縺吶ｋ蜿崎ｻ｢縺ｧ縺阪ｋ繧ｳ繝槭謨ｰ
	                        //    [0] : 荳頑婿蜷
	                        //    [1] : 譁懊ａ蜿ｳ荳頑婿蜷
	                        //    [2] : 蜿ｳ譁ｹ蜷
	                        //    [3] : 譁懊ａ蜿ｳ荳区婿蜷
	                        //    [4] : 荳区婿蜷
	                        //    [5] : 譁懊ａ蟾ｦ荳区婿蜷
	                        //    [6] : 蟾ｦ譁ｹ蜷
	                        //    [7] : 譁懊ａ蟾ｦ荳頑婿蜷
	                        //    [8] : 蜈ｨ菴
	return this;
}
			//
			// GamePanel 繧ｪ繝悶ず繧ｧ繧ｯ繝茨ｼ医Γ繧ｽ繝ラ mouseClick
			//
GamePanel.prototype.mouseClick = function(event)
{
	let x_base  = mp.canvas.offsetLeft;   // 繧ｭ繝｣繝ｳ繝舌せ縺ｮ蟾ｦ荳翫伜ｺｧ讓
	let y_base  = mp.canvas.offsetTop;   // 繧ｭ繝｣繝ｳ繝舌せ縺ｮ蟾ｦ荳翫吝ｺｧ讓
	let x       = event.pageX - x_base;    // 繧ｭ繝｣繝ｳ繝舌せ蜀繧ｯ繝ｪ繝け縺輔ｌ縺滉ｽ咲ｽｮ茨ｽ伜ｺｧ讓呻ｼ
	let y       = event.pageY - y_base;    // 繧ｭ繝｣繝ｳ繝舌せ蜀繧ｯ繝ｪ繝け縺輔ｌ縺滉ｽ咲ｽｮ茨ｽ吝ｺｧ讓呻ｼ
					// 繧ｯ繝ｪ繝け縺輔ｌ縺溘繧ｹ逶ｮ繧堤音螳
	let k = new Array(-1, -1);
	for (let i1 = 0; i1 < 8; i1++) {
		if (y >= gp.gap+i1*(gp.gap+gp.sz) && y <= (i1+1)*(gp.gap+gp.sz)) {
			k[0] = i1;
			break;
		}
	}
	for (let i1 = 0; i1 < 8; i1++) {
		if (x >= gp.gap+i1*(gp.gap+gp.sz) && x <= (i1+1)*(gp.gap+gp.sz)) {
			k[1] = i1;
			break;
		}
	}
					// 蜿崎ｻ｢縺ｧ縺阪ｋ繧ｳ繝槭ｒ謗｢縺
	gp.r_check(k);
							// 蜿崎ｻ｢縺吶ｋ繧ｳ繝槭′縺ｪ縺ｴ蜷
	if (gp.n[8] <= 0) {
		document.getElementById('ta').style.color = "red";
		let str = "の番ですがそこにコマは置けません";
		if (mp.method > 0)
			document.getElementById('ta').innerHTML = "あなた" + str;
		else {
			if (gp.b_w < 0)
				document.getElementById('ta').innerHTML = "黒" + str;
			else
				document.getElementById('ta').innerHTML = "白" + str;
		}
	}
							// 蜿崎ｻ｢縺吶ｋ繧ｳ繝槭′縺ゅｋ蝣ｴ蜷
	else
		gp.set(k);
}
			//
			// k[0] 陦 k[1] 蛻励↓鮟偵∪縺溘逋ｽ b_w 峨繧ｳ繝槭ｒ鄂ｮ縺◆蝣ｴ蜷茨ｼ悟渚霆｢縺ｧ縺阪ｋ繧ｳ繝槭ｒ謗｢縺
			//
GamePanel.prototype.r_check = function(k)
{
	let d = new Array();
	d[0] = new Array(-1, 0);
	d[1] = new Array(-1, 1);
	d[2] = new Array(0, 1);
	d[3] = new Array(1, 1);
	d[4] = new Array(1, 0);
	d[5] = new Array(1, -1);
	d[6] = new Array(0, -1);
	d[7] = new Array(-1, -1);
	gp.n[8] = 0;
	if (k[0] >= 0 && k[1] >= 0 && gp.st[k[0]][k[1]] == 0) {
		for (let i1 = 0; i1 < 8; i1++) {
			let m1   = k[0];
			let m2   = k[1];
			gp.n[i1] = 0;
			let s    = 0;   // 0:髢句ｧ具ｼ1:繧ｫ繧ｦ繝ｳ繝茨ｼ2:繧ｫ繧ｦ繝ｳ繝育ｵゆｺｼ3:蜿崎ｻ｢荳榊庄閭ｽ
			let ct   = 0;
			while (s < 2) {
				m1 += d[i1][0];
				m2 += d[i1][1];
				if (m1 >= 0 && m1 < 8 && m2 >= 0 && m2 < 8) {
					if (gp.st[m1][m2] == 0)
						s = 3;
					else if (gp.st[m1][m2] == gp.b_w) {
						if (s == 1)
							s = 2;
						else
							s = 3;
					}
					else {
						s = 1;
						ct++;
					}
				}
				else
					s = 3;
			}
			if (s == 2) {
				gp.n[8]  += ct;
				gp.n[i1]  = ct;
			}
		}
	}
}
			//
			// 繧ｳ繝槭謫堺ｽ
			//
GamePanel.prototype.set = function(k)
{
					// 蜿崎ｻ｢
	gp.reverse(k);
	gp.b_w = -gp.b_w;
					// 繧ｳ繝槭謨ｰ繧呈焚縺茨ｼ悟享謨玲ｱｺ螳壹繝√ぉ繝け
	let b = 0;
	let w = 0;
	let total = 0;
	for (let i1 = 0; i1 < 8; i1++) {
		for (let i2 = 0; i2 < 8; i2++) {
			if (gp.st[i1][i2] != 0) {
				total++;
				if (gp.st[i1][i2] < 0)
					b++;
				else
					w++;
			}
		}
	}
					// 蜍晄風豎ｺ螳
	if (total == 64) {
		document.getElementById('ta').style.color = "black";
		let str = "黒 " + b + " 個　白 " + w + " 個　";
		if (mp.method > 0) {
			if (b == w)
				document.getElementById('ta').innerHTML = str + "引き分けです";
			else if (b > w && mp.method == 1 || b < w && mp.method == 2)
				document.getElementById('ta').innerHTML = str + "あなたの勝ちです";
			else
				document.getElementById('ta').innerHTML = str + "コンピューターの勝ちです";
		}
		else {
			if (b > w)
				document.getElementById('ta').innerHTML = str + "黒の勝ちです";
			else if (b == w)
				document.getElementById('ta').innerHTML = str + "引き分けです";
			else
				document.getElementById('ta').innerHTML = str + "白の勝ちです";
		}
		mp.canvas.removeEventListener("click", gp.mouseClick);   // 繝ｪ繧ｹ繝翫髯､蜴ｻ
	}
					// 蜍晁ｲ邯咏ｶ
	else {
		document.getElementById('ta').style.color = "black";
		let str = "黒 " + b + " 個　白 " + w + " 個　";
							// 繧ｹ繧ｭ繝縺ｮ繝√ぉ繝け
		let sw = false;
		for (let i1 = 0; i1 < 8 && !sw; i1++) {
			for (let i2 = 0; i2 < 8 && !sw; i2++) {
				k[0] = i1;
				k[1] = i2;
				gp.r_check(k);
				if (gp.n[8] > 0)
					sw = true;
			}
		}
							// 蟇ｾ繧ｳ繝ｳ繝斐Η繝ｼ繧ｿ
		if (mp.method > 0) {
									// 繧ｹ繧ｭ繝縺ｮ蝣ｴ蜷
			if (!sw) {
				gp.b_w = -gp.b_w;
				str += "コマを置けないのでスキップします　";
				if (mp.method == 1 && gp.b_w < 0)
					document.getElementById('ta').innerHTML = str + "あなた(黒)の番です";
				else if (mp.method == 2 && gp.b_w > 0)
					document.getElementById('ta').innerHTML = str + "あなた(白)の番です";
				else {
					document.getElementById('ta').innerHTML = str + "コンピューターの番です";
					k = gp.computer();   // 繧ｳ繝槭ｒ鄂ｮ縺丞ｴ謇縺ｮ豎ｺ螳
					gp.set(k);   // 繧ｳ繝槭ｒ鄂ｮ縺
				}
			}
								// 谺｡縺ｮ謇
			else {
				if (mp.method == 1 && gp.b_w < 0)
					document.getElementById('ta').innerHTML = str + "あなた(黒)の番です";
				else if (mp.method == 2 && gp.b_w > 0)
					document.getElementById('ta').innerHTML = str + "あなた(白)の番です";
				else {
					document.getElementById('ta').innerHTML = str + "コンピューターの番です";
					k = gp.computer();   // 繧ｳ繝槭ｒ鄂ｮ縺丞ｴ謇縺ｮ豎ｺ螳
					gp.set(k);   // 繧ｳ繝槭ｒ鄂ｮ縺
				}
			}
		}
							// 蟇ｾ莠ｺ髢
		else {
									// 繧ｹ繧ｭ繝縺ｮ蝣ｴ蜷
			if (!sw) {
				gp.b_w = -gp.b_w;
				str += "コマを置けないのでスキップします　";
			}
									// 谺｡縺ｮ謇
			if (gp.b_w < 0)
				document.getElementById('ta').innerHTML = str + "黒の番です";
			else
				document.getElementById('ta').innerHTML = str + "白の番です";
		}
	}
}
			//
			// k[0] 陦 k[1] 蛻励↓鮟偵∪縺溘逋ｽ b_w 峨繧ｳ繝槭ｒ鄂ｮ縺◆蝣ｴ蜷医↓縺翫￠繧九さ繝槭蜿崎ｻ｢
			//
GamePanel.prototype.reverse = function(k)
{
	let d = new Array();
	d[0] = new Array(-1, 0);
	d[1] = new Array(-1, 1);
	d[2] = new Array(0, 1);
	d[3] = new Array(1, 1);
	d[4] = new Array(1, 0);
	d[5] = new Array(1, -1);
	d[6] = new Array(0, -1);
	d[7] = new Array(-1, -1);
	for (let i1 = 0; i1 < 8; i1++) {
		let m1   = k[0];
		let m2   = k[1];
		for (let i2 = 0; i2 < gp.n[i1]; i2++) {
			m1 += d[i1][0];
			m2 += d[i1][1];
			gp.st[m1][m2] = gp.b_w;
		}
	}
	gp.st[k[0]][k[1]] = gp.b_w;
					// 謠冗判
	gp.draw();
}
			//
			// 繧ｳ繝ｳ繝斐Η繝ｼ繧ｿ縺檎ｽｮ縺上さ繝槭蝣ｴ謇繧呈ｱｺ螳
			//
GamePanel.prototype.computer = function()
{
	let k = new Array();
	let kk = new Array();
	let mx = new Array();
	mx[8] = 0;
	for (let i1 = 0; i1 < 8; i1++) {
		for (let i2 = 0; i2 < 8; i2++) {
			kk[0] = i1;
			kk[1] = i2;
			gp.r_check(kk);
			if (gp.n[8] > mx[8]) {
				k[0] = kk[0];
				k[1] = kk[1];
				for (let i3 = 0; i3 < 9; i3++)
					mx[i3] = gp.n[i3];
			}
		}
	}
	for (let i1 = 0; i1 < 9; i1++)
		gp.n[i1] = mx[i1];
	return k;
}
			//
			// GamePanel 繧ｪ繝悶ず繧ｧ繧ｯ繝茨ｼ医Γ繧ｽ繝ラ draw
			//
GamePanel.prototype.draw = function()
{
					// 繧ｭ繝｣繝ｳ繝舌せ縺ｮ繧ｯ繝ｪ繧｢
	mp.ctx.clearRect(0, 0, mp.canvas.width, mp.canvas.height);
					// 謠冗判
	mp.ctx.beginPath();
	mp.ctx.fillStyle = "rgb(165, 42, 42)";
	mp.ctx.fillRect(0, 0, mp.canvas.width, mp.canvas.height);
	mp.ctx.fill();

	for (let i1 = 0; i1 < 8; i1++) {
		for (let i2 = 0; i2 < 8; i2++) {
			let x = gp.gap + i2 * (gp.sz + gp.gap);
			let y = gp.gap + i1 * (gp.sz + gp.gap);
			mp.ctx.beginPath();
			mp.ctx.fillStyle = "rgb(0, 255, 0)";
			mp.ctx.fillRect(x, y, gp.sz, gp.sz);
			mp.ctx.fill();
			if (gp.st[i1][i2] != 0) {
				x += Math.floor(gp.sz / 2);
				y += Math.floor(gp.sz / 2);
				mp.ctx.beginPath();
				if (gp.st[i1][i2] < 0)
					mp.ctx.fillStyle = "rgb(0, 0, 0)";
				else
					mp.ctx.fillStyle = "rgb(255, 255, 255)";
				mp.ctx.arc(x, y, Math.floor(gp.sz/2)-2, 0, 2*Math.PI);
				mp.ctx.fill();
			}
		}
	}
}
      </script>
	</head>
	<body CLASS="eeffee" onLoad="mp_start()">
		<H1>othello</H1>
		<CANVAS ID="canvas_e" STYLE="background-color: #ffffff;" WIDTH="435" HEIGHT="435"></CANVAS><BR />
		<BUTTON ID="g_method0" CLASS="std" onClick="JavaScript: mp.method=0; gp_start()">対人間</BUTTON>
		<BUTTON ID="g_method1" CLASS="std" onClick="JavaScript: mp.method=1; gp_start()">対コンピュータ（人先手）</BUTTON>
		<BUTTON ID="g_method2" CLASS="std" onClick="JavaScript: mp.method=2; gp_start()">対コンピュータ（人後手）</BUTTON>
		<textarea ID="ta" TYPE="text" NAME="ta" COLS="40" ROWS="5" CLASS="std"></textarea><BR />
		<BUTTON ID="first" CLASS="std" onClick="st_start()">再開</BUTTON>
		<BUTTON ID="finish" CLASS="std" onClick="mp.finish()">終了</BUTTON>
  	<div id="reloadBtn" class="floating-btn" onclick="reload()">↻</div>
    <div id="logoutBtn" class="floating-btn" onclick="backPage()">⇦</div>
  <script>
    const urlParams = new URLSearchParams(location.search);
    const token1 = urlParams.get("key1");
	const token3 = localStorage.getItem("account1");
    localStorage.setItem("account1", "");
    if((token1 !== localStorage.getItem("key1")) || (token3 == "") || (token3 == null)){
        localStorage.setItem("key1", "unauthorized");
		localStorage.setItem("requestPage1", "game/page0003/page0003");
        location.href = "/game-sites/";
    }else{
        localStorage.setItem("key1", "");
		localStorage.setItem("requestPage1", "");
        setInterval(() => {
            sendToGAS(token3, "", "page");
        }, 5000);
    }

    /* ======== Google Apps Script Web App URL ======== */
    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycbxzyrgvalRn0lOL0jF-OL39xFCn_1tga9l1TVt283uKUftgx7E4nPn4zpvwOBRObpiMLA/exec";
    /* ======== GASに送信する処理 ======== */
    async function sendToGAS(User, text, status){
      const payload = {
        user: User,
        message: text,
        status
      };
      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",   // ← GAS が CORS 許可してないため必要
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.error("送信エラー:", e);
      }
	}

    function reload(){
        const key1 = crypto.randomUUID();
        localStorage.setItem("key1", key1);
		localStorage.setItem("account1", token3);
        location.href = "/game-sites/game/page0003/page0003?key1=" + key1;
    }
    function backPage(){
        const key1 = crypto.randomUUID();
        localStorage.setItem("key1", key1);
		localStorage.setItem("account1", token3);
        location.href = "/game-sites/top/top0001/top0001?key1=" + key1;
    }
  </script>
	</body>
	</html>
