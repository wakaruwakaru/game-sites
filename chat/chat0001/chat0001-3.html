<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/game-sites/index/icon/icon1.png" >
  <link rel="stylesheet" href="./css/main.css" />
  <title>ãƒãƒ£ãƒƒãƒˆ</title>
  <style type="text/css">
/* ===== ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‘ãƒãƒ«æœ¬ä½“ ===== */
.media-panel{
  position: fixed;
  bottom: 90px; /* å…¥åŠ›æ¬„ã®ä¸Š */
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  width: 600px;
  max-width: 92%;
  height: 340px;
  background: #0a0f18;
  border-radius: 16px;
  border: 2px solid #4da6ff;
  box-shadow:
    0 0 20px #4da6ff88,
    0 0 60px #4da6ff44;
  opacity: 0;
  pointer-events: none;
  transition: 
    opacity 0.25s ease,
    transform 0.25s ease;
  z-index: 9998;
  display: flex;
  flex-direction: column;
}

/* è¡¨ç¤ºçŠ¶æ…‹ */
.media-panel.show{
  opacity: 1;
  pointer-events: auto;
  transform: translateX(-50%) translateY(0);
}

/* ===== ãƒ˜ãƒƒãƒ€ï¼ˆã‚¿ãƒ–ï¼‰ ===== */
.media-header{
  display: flex;
  gap: 8px;
  padding: 10px;
  border-bottom: 1px solid #4da6ff55;
}

.media-header .tab{
  background: transparent;
  border: none;
  color: #8bbcff;
  padding: 6px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 14px;
}

.media-header .tab.active{
  background: #4da6ff22;
  box-shadow: 0 0 10px #4da6ff99;
  color: #e6f7ff;
}

/* ===== æ¤œç´¢æ¬„ ===== */
.media-search{
  padding: 8px 10px;
}

.media-search input{
  width: 100%;
  background: #000;
  border: 1px solid #4da6ff;
  border-radius: 8px;
  padding: 6px 10px;
  color: #8bbcff;
}

/* ===== ä¸­èº« ===== */
.media-content{
  flex: 1;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
  gap: 10px;
  overflow-y: auto;
}

.media-item{
  height: 56px;
  background: #000;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 0 6px #4da6ff55;
  transition: 0.2s;
}

.media-item:hover{
  transform: scale(1.1);
  box-shadow: 0 0 16px #4da6ffcc;
}

  </style>
</head>

<body>
  <!-- ãƒãƒ£ãƒƒãƒˆæœ¬ä½“ -->
  <div class="chat-container" id="message1"></div>

  <!-- å…¥åŠ›æ¬„ -->
  <div class="input-wrapper">
    <div class="icon-left" onclick="toggleMediaPanel()">+</div>
    <input type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡" id="textBox1" onkeyup="enterSend(event)">
    <div class="icon-right" onclick="rate_change()"></div>
  </div>
  <!-- æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° -->
  <div id="new-msg" class="new-msg"></div>
  <!-- æœ€çµ‚æ›´æ–°æ™‚é–“ -->
  <div id="last-change-time" class="last-change-time">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­</div>

<div id="bottomBtn" class="floating-btn" onclick="scrollToBottom()">â‡©</div>
<div id="reloadBtn" class="floating-btn" onclick="reload()">â†»</div>
<div id="logoutBtn" class="floating-btn" onclick="backPage()">â‡¦</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ— / GIF ãƒ‘ãƒãƒ« -->
<div class="media-content" id="mediaContent">

  <!-- GIF -->
  <div class="media-item"
       data-type="gif"
       data-id="nerd_face"
       data-url="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif">
    <img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif">
  </div>

  <!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
  <div class="media-item"
       data-type="stamp"
       data-id="stamp_001"
       data-url="/stamps/stamp001.png">
    <img src="/stamps/stamp001.png">
  </div>

  <!-- çµµæ–‡å­— -->
  <div class="media-item"
       data-type="emoji"
       data-id="smile">
    ğŸ˜€
  </div>

</div>

  
</body>
<script>

const mediaContent = document.getElementById("mediaContent");
mediaContent.addEventListener("click", (e) => {
  const item = e.target.closest(".media-item");
  if (!item) return;

  const type = item.dataset.type; // gif / stamp / emoji
  const id   = item.dataset.id;
  const url  = item.dataset.url || "";

  onMediaSelected({ type, id, url });
});

function onMediaSelected(media){
  console.log("é¸æŠ:", media);

  // è¡¨ç¤ºç”¨ï¼ˆè‡ªåˆ†ã®å¹ãå‡ºã—ã«å³åæ˜ ï¼‰
  //addMediaMessage(media);

  // GASã«é€ä¿¡
  //sendMediaToGAS(media);

  // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
  document.getElementById("mediaPanel").classList.remove("show");
}





  
    /* ======== Google Apps Script Web App URL ======== */
    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycbwO-h9O7dQhfKSnpVvE2opZXEJJlPV9LAGBSiFUR3-2m6jh8pCvo5JbJUW0cWxRn7MS/exec";

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID â†’ ã‚¢ã‚¤ã‚³ãƒ³URL
    const userIcons = {
      default:      "/game-sites/chat/chatIcons/default-0001.png",
      wakaruwakaru: "/game-sites/chat/chatIcons/wakaruwakaru-0001.png",
      dabada:       "/game-sites/chat/chatIcons/dabada-0001.png",
      173:          "/game-sites/chat/chatIcons/173-0001.png",
      RTX5090rairai:"/game-sites/chat/chatIcons/rairai-0001.png"
    };

    /* ======== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ ======== */
    async function send() {
      const box = document.getElementById("textBox1");
      const text = box.value.trim();
      if (!text) return;
      
      scrollToBottom();
      // å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
      box.value = "";
      box.focus();

      const text2 = text_trim(text, "mess");

      // GAS ã¸é€ä¿¡
      sendToGAS("takuan", text2, "00:00");
    }

    /* ============ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚°=========== */
    async function send_login() {
      const text2 = text_trim("", "logi");
      // GAS ã¸é€ä¿¡
      sendToGAS("takuan", text2, "00:00");
    }
    
    /* ======== GASã«é€ä¿¡ã™ã‚‹å‡¦ç† ======== */
    async function sendToGAS(user, text, time){
      const payload = {
        user,
        message: text,
        time
      };

      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",   // â† GAS ãŒ CORS è¨±å¯ã—ã¦ãªã„ãŸã‚å¿…è¦
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        // no-cors ã®ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯èª­ã‚ãªã„ï¼ˆä»•æ§˜ï¼‰
      } catch (e) {
        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    /* ======== å¹ãå‡ºã—è¿½åŠ ï¼ˆé€ä¿¡å´ï¼‰ ======== */
    function addMessage_sent1(text, time){
      const msg = document.createElement("div");
      msg.className = "message sent";
      msg.innerHTML = `
        <div class="message-content">
          <p>${text}</p>
          <span class="timestamp">${time}</span>
        </div>
      `;
      document.getElementById("message1").appendChild(msg);
    }

    /* ======== å¹ãå‡ºã—è¿½åŠ ï¼ˆå—ä¿¡å´ï¼‰ ======== */
function addMessage_received1(user, text, time){
  const iconUrl = userIcons[user] || userIcons["default"]; // ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

  const msg = document.createElement("div");
  msg.className = "message received";
  msg.innerHTML = `
    <div class="user-icon" style="background-image:url('${iconUrl}');"></div>
    <div class="message-content">
      <p>${text}</p>
      <span class="timestamp">${time}</span>
    </div>
  `;
  document.getElementById("message1").appendChild(msg);
}
/*=============æ™‚é–“ãƒ”ãƒ«è¿½åŠ ==============*/
function addDatePill(text){
  // ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆä¸­å¤®å¯„ã›ï¼‰
  const wrapper = document.createElement("div");
  wrapper.className = "center-set";
  // ãƒ”ãƒ«æœ¬ä½“ï¼ˆè¦‹ãŸç›®ï¼‰
  const pill = document.createElement("div");
  pill.className = "chat-date-pill";
  pill.textContent = text;
  // wrapper ã®ä¸­ã« pill ã‚’å…¥ã‚Œã‚‹
  wrapper.appendChild(pill);
  // message1 ã«æŒ¿å…¥
  document.getElementById("message1").appendChild(wrapper);
}

    /* ======== è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ======== */
    function scrollToBottom(){
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth"
      });
    }

    /* ======== ã‚¨ãƒ³ã‚¿ãƒ¼é€ä¿¡ ======== */
    function enterSend(e){
      if (e.key === "Enter") send();
    }
    
    function text_trim(text1, text2){
      return `<type[${text2}]acco[${token3}]time[${new Date()}]val1[${text1}]>`;
    }

const box = document.getElementById("textBox1");
box.addEventListener("keydown", (e) => {  // ã‚­ãƒ¼å…¥åŠ›ã‚’ãƒ–ãƒ­ãƒƒã‚¯
  if(["<", ">", "[", "]"].includes(e.key)){
    e.preventDefault();
  }
});
box.addEventListener("input", () => {  // ã¾ã¨ã‚ã¦é™¤å»
  box.value = box.value.replace(/[<>\[\]]/g, "");
});


function splitLogs(text){
  return text.match(/<[^>]*>/g) || [];
}

function parseLog(log){
  const result = {};
  const inside = log.slice(1, -1);
  const parts = inside.split("]");

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i].trim();
    if (part === "") continue;

    const keyValue = part.split("[");
    const key = keyValue[0];
    const value = keyValue[1];

    result[key] = value;
  }
  return result;
}

function toHHMM(timeString) {
  const d = new Date(timeString); // æ–‡å­—åˆ— â†’ Date ã«å¤‰æ›
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");
  return `${hh}:${mm}`;
}
function toYYYYMMDD(dateString) {
  const d = new Date(dateString);
  const year  = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day   = String(d.getDate()).padStart(2, "0");
  return `${year}å¹´${month}æœˆ${day}æ—¥`;
}

function getScrollPercentage(){
    const currentScroll = window.scrollY;                      // A. ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ï¼ˆä¸Šç«¯ã‹ã‚‰ã®è·é›¢ï¼‰
    const fullHeight = document.documentElement.scrollHeight;  // B. ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã®é«˜ã•
    const viewportHeight = window.innerHeight;                 // C. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆï¼ˆè¡¨ç¤ºé ˜åŸŸï¼‰ã®é«˜ã•
    // ----------------------------------------------------
    // 2. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªæœ€å¤§ã®è·é›¢ã‚’è¨ˆç®—   ãƒšãƒ¼ã‚¸å…¨é•·ã‹ã‚‰è¡¨ç¤ºé ˜åŸŸã®åˆ†ã‚’å¼•ã
    const maxScrollDistance = fullHeight - viewportHeight;
    // æœ€å¤§è·é›¢ãŒ0ã®å ´åˆã¯ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ããªã„ï¼ˆãƒšãƒ¼ã‚¸ãŒçŸ­ã„ï¼‰ãŸã‚0%ã‚’è¿”ã™
    if (maxScrollDistance === 0) {
        return 0;
    }
    // ----------------------------------------------------
    // 3. ç›¸å¯¾å€¤ï¼ˆ%ï¼‰ã‚’è¨ˆç®—ã—ã€å°æ•°ç‚¹ä»¥ä¸‹ã‚’ä¸¸ã‚ã‚‹
    const scrollPercentage = (currentScroll / maxScrollDistance) * 100;
    // 0ã€œ100ã®é–“ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ï¼ˆå¿µã®ãŸã‚ï¼‰
    return Math.min(100, Math.max(0, scrollPercentage));
}
    
function autoScrollValue(){
    const currentScroll = window.scrollY;
    const fullHeight = document.documentElement.scrollHeight;
    const viewportHeight = window.innerHeight;
    const ScrollDistance = (fullHeight - viewportHeight) - currentScroll;
    if(100 < ScrollDistance){
      return 0;
    }else{
      return 1;
    }
}

const msg1 = document.getElementById("new-msg");
function new_msg(text){
  msg1.textContent = text;
  msg1.classList.add("show");
  /* 1.5ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  setTimeout(() => {
    msg1.classList.remove("show");
  }, 1500);
  */
}

function diffSeconds(get_old_date) {
  const oldTime = new Date(get_old_date).getTime();  // éå»ã®æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
  const nowTime = Date.now();                    // ç¾åœ¨ã®æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
  const diffMs = nowTime - oldTime;              // ãƒŸãƒªç§’å·®
  return Math.floor(diffMs / 1000);              // ç§’ã«å¤‰æ›
}
    
var old_content = 0;
var new_content = 0;
var old_mess_date = "";
var new_mess_date = "";
var new_message = 0;
var renew_time = 0;
async function page_update(){
  const res = await fetch(WEB_APP_URL);
  const data = await res.json();
  const text1 = data.content;

  // â‘  æ–‡å­—åˆ—ã‚’ãƒ­ã‚°ã”ã¨ã«é…åˆ—ã¸
  const logs = splitLogs(text1);

  // â‘¡ ãã‚Œãã‚Œã®ãƒ­ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹ â†’ å¤šæ¬¡å…ƒé…åˆ—ã¸
  const message2 = logs.map(log => {
    const p = parseLog(log);
    return [ p.type, p.acco, p.time, p.val1 ];
  });

  // â‘¢ å‡ºåŠ›
  renew_time = new Date();
  old_content = new_content;
  new_content = message2.length;
  if(old_content != new_content){
    const auto_scroll = autoScrollValue();
    for(let i = old_content; i < message2.length; i++){
      if(message2[i][0] == "mess"){
        old_mess_date = new_mess_date;
        new_mess_date = toYYYYMMDD(message2[i][2]);
        if(old_mess_date != new_mess_date){
          addDatePill(new_mess_date);
        }
        if(message2[i][1] == token3){
          addMessage_sent1(message2[i][3], toHHMM(message2[i][2]));
        }else{
          addMessage_received1(message2[i][1], message2[i][3], toHHMM(message2[i][2]));
          if((!auto_scroll) && (!new_message)){
            new_message = 1;
            new_msg("æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸");
          }
        }
      }
    }
    if(auto_scroll){
      scrollToBottom();
    }
  }

}

let ticking = false;
window.addEventListener("scroll", () => {
  if(!ticking){
    window.requestAnimationFrame(() => {
      if((autoScrollValue()) && (new_message)){
        msg1.classList.remove("show");
        new_message = 0;
      }
      ticking = false;
    });
    ticking = true;
  }
});

    
var timer1 = null;
var update_rate = 1000;
function event1() {
  page_update();
}
timer1 = setInterval(event1, update_rate);
function rate_change(){
  if(update_rate === 1000) {
    document.querySelector(".icon-right").style.backgroundColor = "#7dd6ff";
    update_rate = 5000;
  }else{
    document.querySelector(".icon-right").style.backgroundColor = "#000000";
    update_rate = 1000;
  }
  clearInterval(timer1);
  timer1 = setInterval(event1, update_rate);
}

var timer2 = null;
function event2(){
  if(renew_time != 0){
    if(diffSeconds(renew_time) < 60){
      document.getElementById("last-change-time").innerHTML = "æœ€çµ‚æ›´æ–°: " + diffSeconds(renew_time) + "ç§’å‰";
    }else{
      document.getElementById("last-change-time").innerHTML = "æœ€çµ‚æ›´æ–°: " + toHHMM(renew_time);
    }
  }
}timer2 = setInterval(event2, 200);
    
  const urlParams = new URLSearchParams(location.search);
  const token1 = urlParams.get("key1");
  const token3 = localStorage.getItem("account1");
  localStorage.setItem("account1", "");
  if((token1 !== localStorage.getItem("key1")) || (token3 == "token3")  || (token3 == "") || (token3 == null)){
    localStorage.setItem("key1", "unauthorized");
    localStorage.setItem("requestPage1", "chat/chat0001/chat0001");
 //   location.href = "/game-sites/";
  }else{
    localStorage.setItem("key1", "");
    localStorage.setItem("requestPage1", "");
    send_login();
  }

  function reload(){
    const key1 = crypto.randomUUID();
    localStorage.setItem("key1", key1);
    localStorage.setItem("account1", token3);
    location.href = "/game-sites/chat/chat0001/chat0001?key1=" + key1;
  }
  function backPage(){
    const key1 = crypto.randomUUID();
    localStorage.setItem("key1", key1);
    localStorage.setItem("account1", token3);
    location.href = "/game-sites/top/top0001/top0001?key1=" + key1;
  }
</script>
</html>
