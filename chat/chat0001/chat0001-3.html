<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/game-sites/index/icon/icon1.png" >
  <title>ãƒãƒ£ãƒƒãƒˆ</title>
  <style type="text/css">
    body {
      font-family: Arial, sans-serif;
      background-color: #000000;
      margin: 0;
      padding: 0;
      user-select:none;
    }
    .chat-container {
      max-width: 600px;
      margin: 20px auto 100px auto;
      padding: 10px;
      background-color: #000000;
      border-radius: 8px;
      box-shadow: 0 0 8px #4da6ff, 0 0 20px #4da6ff;
    }
    .message {
      display: flex;
      margin-bottom: 15px;
      align-items: flex-end;
    }
    .received { justify-content: flex-start; }
    .sent { justify-content: flex-end; }

.user-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  background-color: #333;
  margin-right: 10px;
  box-shadow: 0 0 8px #4da6ff, 0 0 18px #4da6ff;
}

    .message-content {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      position: relative;
    }
    .message-content p {
      margin: 0;
      word-wrap: break-word;
    }
    .emoji {
      font-size: 48px;
    }
    .message-content img {
      width: 200px;
    }
    .timestamp {
      font-size: 11px;
      color: #999;
      white-space: nowrap;
    }
    .received .message-content {
      background-color: #000000;
      box-shadow: 0 0 8px #4da6ff, 0 0 20px #4da6ff;
      color: #ffffff;
      border-bottom-left-radius: 4px;
      order: 2;
    }
    .received .timestamp { margin-left: 8px; order: 3; }
    .sent .message-content {
      background-color: #000000;
      box-shadow: 0 0 8px #00ffff, 0 0 20px #00ffff;
      color: #ffffff;
      border-bottom-right-radius: 4px;
      order: 2;
    }
    .sent .timestamp { margin-right: 8px; order: 1; }
    .sent { padding-right: 50px; }

    .input-wrapper {
      display: flex;
      align-items: center;
      background: #000000;
      border-radius: 40px;
      border: 2px solid #4da6ff;
      padding: 10px 16px;
      width: 600px;
      max-width: 90%;
      box-shadow: 0 0 0px #4da6ff, 0 0 40px #4da6ff;
      gap: 12px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .icon-left {
      font-size: 20px;
      font-weight: bold;
      padding: 6px;
      color:#4da6ff;
      cursor: pointer;
    }
    .input-wrapper input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      background-color:#000000;
      color:#4da6ff;
      border: 2px solid #4da6ff;
      padding:5px 10px;
    }
    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ï¼šã•ã‚‰ã«å¼·ãå…‰ã‚‹ */
    .input-wrapper input:focus {
      box-shadow:
        0 0 5px #4da6ff,
        0 0 10px #3d8cff,
        0 0 15px #3d8fff;
      border-color: #82c0ff; /* ã¡ã‚‡ã£ã¨æ˜ã‚‹ã„è‰²ã« */
    }
    .input-wrapper input::placeholder {
      color: #8bbcff;
      opacity: 0.7;
    }  
    .icon-right {
      width: 36px;
      height: 36px;
      background: #000000;
      border: 2px solid #4da6ff;
      border-radius: 50%;
      box-shadow: 0 0 18px #4da6ff, 0 0 1px #4da6ff;
      cursor: pointer;
    }


/* --- æ—¥ä»˜ãƒ”ãƒ«ï¼ˆãƒã‚ªãƒ³é¢¨ï¼‰ --- */
.chat-date-pill{
  display: inline-block;
  padding: 8px 20px;
  border-radius: 999px;              /* ä¸¸ã„ãƒ”ãƒ« */
  background: rgba(10,12,18,0);   /* åŠé€æ˜ã®æš—ã„èƒŒæ™¯ï¼ˆã‚¬ãƒ©ã‚¹ã£ã½ãï¼‰ */
  color: #e6f7ff;
  font-weight: 600;
  font-size: 14px;
  line-height: 1;
  text-align: center;
  border: 1px solid rgba(77,166,255,1);
  backdrop-filter: blur(6px);        /* èƒŒæ™¯ã®ã¼ã‹ã— */
  position: relative;
  margin: 18px auto;                 /* ä¸Šä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹ã€æ¨ªã¯ä¸­å¤®ï¼ˆè¦ªå¹…ã«ä¾å­˜ï¼‰ */
  box-shadow:
    0 0 6px rgba(77,166,255,0.12),
    0 0 18px rgba(77,166,255,0.06);
  z-index: 10;
}
/* å°ç”»é¢ã§å¹…ã‚’å°‘ã—ç¸®ã‚ã‚‹ */
@media (max-width: 420px) {
  .chat-date-pill {
    padding: 6px 14px;
    font-size: 13px;
  }
}
.center-set{
    text-align:center;
}


.new-msg {
  position: fixed;
  bottom: 100px;
  left: 20px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  font-size: 14px;
  box-shadow: 0 0 0px #ffa6ff, 0 0 20px #ffa6ff;
  border: 2px solid #ffa6ff;
}
.new-msg.show {
  opacity: 1;
}

.last-change-time{
  position: fixed;
  bottom: 5px;
  color: #909090;
  font-size: 10px;
  display: flex;
  right: 10px
}

/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ */
.floating-btn{
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    background: #111;
    border: 2px solid #4da6ff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 26px;
    color: #bcdfff;
    cursor: pointer;
    transition: 0.25s;
    box-shadow: 0 0 10px #3d8cff88;
}
/* ãƒ›ãƒãƒ¼æ™‚ã«å…‰ã‚‹ */
.floating-btn:hover{
    background: #4da6ff33;
    box-shadow: 0 0 16px #4da6ffcc;
}
/* ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç¸®ã‚€ */
.floating-btn:active{
    transform: scale(0.9);
}
/* ãƒœã‚¿ãƒ³ä½ç½®èª¿æ•´ */
#reloadBtn{
    bottom: 160px; /* logout ã®ä¸Šã«é…ç½® */
}
#logoutBtn{
    bottom: 90px;
}
#bottomBtn{
    bottom: 230px;
}



















/* ===== ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‘ãƒãƒ«æœ¬ä½“ ===== */
.media-panel{
  position: fixed;
  bottom: 90px; /* å…¥åŠ›æ¬„ã®ä¸Š */
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  width: 600px;
  max-width: 92%;
  height: 340px;
  background: #0a0f18;
  border-radius: 16px;
  border: 2px solid #4da6ff;
  box-shadow:
    0 0 20px #4da6ff88,
    0 0 60px #4da6ff44;
  opacity: 0;
  pointer-events: none;
  transition: 
    opacity 0.25s ease,
    transform 0.25s ease;
  z-index: 9998;
  display: flex;
  flex-direction: column;
}

/* è¡¨ç¤ºçŠ¶æ…‹ */
.media-panel.show{
  opacity: 1;
  pointer-events: auto;
  transform: translateX(-50%) translateY(0);
}

/* ===== ãƒ˜ãƒƒãƒ€ï¼ˆã‚¿ãƒ–ï¼‰ ===== */
.media-header{
  display: flex;
  gap: 8px;
  padding: 10px;
  border-bottom: 1px solid #4da6ff55;
}

.media-header .tab{
  background: transparent;
  border: none;
  color: #8bbcff;
  padding: 6px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 14px;
}

.media-header .tab.active{
  background: #4da6ff22;
  box-shadow: 0 0 10px #4da6ff99;
  color: #e6f7ff;
}

/* ===== æ¤œç´¢æ¬„ ===== */
.media-search{
  padding: 8px 10px;
}

.media-search input{
  width: 100%;
  background: #000;
  border: 1px solid #4da6ff;
  border-radius: 8px;
  padding: 6px 10px;
  color: #8bbcff;
}

/* ===== ä¸­èº« ===== */
.media-content{
  flex: 1;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
  gap: 10px;
  overflow-y: auto;
}

.media-item:hover{
  transform: scale(1.1);
  box-shadow: 0 0 16px #4da6ffcc;
}

.media-item{
  width: 56px;          /* ã™ã§ã«æŒ‡å®šã—ã¦ã‚‹ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ */
  height: 56px;
  font-size: 40px;
  border-radius: 10px;
  overflow: hidden;     /* ã¯ã¿å‡ºã—é˜²æ­¢ */
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* media-item å†…ã®ç”»åƒ */
.media-item img{
  width: 100%;
  height: 100%;
  object-fit: cover;    /* â† æœ€é‡è¦ */
  display: block;
  pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã¯è¦ªãŒæ‹¾ã† */
}
  </style>
</head>

<body>
  <!-- ãƒãƒ£ãƒƒãƒˆæœ¬ä½“ -->
  <div class="chat-container" id="message1"></div>

  <!-- å…¥åŠ›æ¬„ -->
  <div class="input-wrapper">
    <div class="icon-left" onclick="toggleMediaPanel()">+</div>
    <input type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡" id="textBox1" onkeyup="enterSend(event)">
    <div class="icon-right" onclick="rate_change()"></div>
  </div>
  <!-- æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° -->
  <div id="new-msg" class="new-msg"></div>
  <!-- æœ€çµ‚æ›´æ–°æ™‚é–“ -->
  <div id="last-change-time" class="last-change-time">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­</div>

<div id="bottomBtn" class="floating-btn" onclick="scrollToBottom()">â‡©</div>
<div id="reloadBtn" class="floating-btn" onclick="reload()">â†»</div>
<div id="logoutBtn" class="floating-btn" onclick="backPage()">â‡¦</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ— / GIF ãƒ‘ãƒãƒ« -->
<div id="mediaPanel" class="media-panel">
  <div class="media-header">
    <button class="tab active" data-target="emoji">çµµæ–‡å­—</button>
    <button class="tab" data-target="stamp">ã‚¹ã‚¿ãƒ³ãƒ—</button>
    <button class="tab" data-target="gif">GIF</button>
  </div>
  <div class="media-search">
    <input type="text" placeholder="æ¤œç´¢ã€€å®Ÿè£…ä¸­â€¦" />
  </div>
  <div class="media-content" id="mediaContent" data-mode="emoji">
  </div>
</div>
  
</body>
<script>

const panel = document.getElementById("mediaPanel");
function toggleMediaPanel(){
  panel.classList.toggle("show");
}

// ãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆæœ€å°ä¾µè¥²ï¼‰
document.addEventListener("click", (e) => {
  // ãƒ‘ãƒãƒ«ãŒé–‰ã˜ã¦ã„ã‚‹ãªã‚‰ä½•ã‚‚ã—ãªã„
  if (!panel.classList.contains("show")) return;
  // ãƒ‘ãƒãƒ«å†…ã‚¯ãƒªãƒƒã‚¯ãªã‚‰ç„¡è¦–
  if (panel.contains(e.target)) return;
  // ï¼‹ãƒœã‚¿ãƒ³è‡ªèº«ãªã‚‰ç„¡è¦–
  if (e.target.closest(".icon-left")) return;
  // ãã‚Œä»¥å¤– â†’ é–‰ã˜ã‚‹
  panel.classList.remove("show");
});


const tabs = document.querySelectorAll(".media-header .tab");
const mediaContent = document.getElementById("mediaContent");
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    const target = tab.dataset.target; // gif / stamp / emoji
    // â‘  ã‚¿ãƒ–ã® active åˆ‡ã‚Šæ›¿ãˆ
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    // â‘¡ mediaContent ã®ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    mediaContent.dataset.mode = target;
    // â‘¢ è¡¨ç¤ºå†…å®¹åˆ‡ã‚Šæ›¿ãˆï¼ˆä»®ï¼‰
    updateMediaContent(target);
  });
});
mediaContent.addEventListener("click", (e) => {
  const item = e.target.closest(".media-item");
  if (!item) return;
  const type = item.dataset.type;
  const id = item.dataset.id;

  const text2 = text_trim(id, type);
  sendToGAS("takuan", text2, "00:00");
  panel.classList.remove("show");
});

function updateMediaContent(type){
  mediaContent.innerHTML = "";
  if(type == "emoji"){
    renderEmojiList();
  }else if(type == "stamp"){
    renderStampList();
  }else if(type == "gif"){
    renderGifList();
  }
}

const segmenter = new Intl.Segmenter("ja", { granularity: "grapheme" });
const emoji_list = [...segmenter.segment(
  "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ¤£ğŸ˜‚ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜‰ğŸ˜ŠğŸ˜‡ğŸ¥°ğŸ˜ğŸ¤©ğŸ˜˜ğŸ˜—ğŸ˜šğŸ˜™ğŸ¥²ğŸ˜‹ğŸ˜›ğŸ˜œğŸ¤ªğŸ˜ğŸ¤‘ğŸ¤—ğŸ¤­ğŸ«¢ğŸ«£ğŸ¤«ğŸ¤”ğŸ«¡" +
  "ğŸ¤ğŸ¤¨ğŸ˜ğŸ˜‘ğŸ˜¶ğŸ«¥ğŸ˜¶â€ğŸŒ«ï¸ğŸ˜¶â€ğŸŒ«ï¸ğŸ˜ğŸ˜’ğŸ™„ğŸ˜¬ğŸ˜®â€ğŸ’¨ğŸ¤¥ğŸ«¨ğŸ™‚â€â†”ï¸ğŸ™‚â€â†•ï¸ğŸ˜ŒğŸ˜”ğŸ˜ªğŸ¤¤ğŸ˜´ğŸ«©ğŸ˜·ğŸ¤’ğŸ¤•ğŸ¤¢ğŸ¤®ğŸ¤§ğŸ¥µğŸ¥¶ğŸ¥´ğŸ˜µğŸ¤¯" +
  "ğŸ˜•ğŸ«¤ğŸ˜ŸğŸ™ğŸ˜®ğŸ˜¯ğŸ˜²ğŸ˜³ğŸ¥ºğŸ¥¹ğŸ˜¦ğŸ˜§ğŸ˜¨ğŸ˜°ğŸ˜¥ğŸ˜¢ğŸ˜­ğŸ˜±ğŸ˜–ğŸ˜£ğŸ˜ğŸ˜“ğŸ˜©ğŸ˜«ğŸ¥±" +
  "ğŸ¤ ğŸ¥³ğŸ¥¸ğŸ˜ğŸ¤“ğŸ§ğŸ˜¤ğŸ˜¡ğŸ˜ ğŸ¤¬ğŸ˜ˆğŸ‘¿ğŸ’€ğŸ¤¡ğŸ‘¹ğŸ‘ºğŸ‘»ğŸ‘½ğŸ‘¾ğŸ¤–" +
  "ğŸ’ŒğŸ’˜ğŸ’ğŸ’–ğŸ’—ğŸ’“ğŸ’ğŸ’•ğŸ’ŸğŸ’”â¤ï¸â€ğŸ”¥â¤ï¸â€ğŸ©¹ğŸ’¯ğŸ’¢ğŸ’¥ğŸ’«ğŸ’¦ğŸ’¨ğŸ•³ï¸ğŸ’£ğŸ’¬ğŸ‘â€ğŸ—¨ğŸ—¨ï¸ğŸ—¯ï¸ğŸ’­ğŸ’¤" +
  "ğŸ‘¥ğŸ«‚ğŸ‘¤ğŸ—£ï¸ğŸ‘£ğŸ«†ğŸ§ ğŸ«€ğŸ«ğŸ©¸ğŸ¦ ğŸ¦·ğŸ¦´ğŸ‘€ğŸ‘ï¸ğŸ‘„ğŸ«¦ğŸ‘…ğŸ‘ƒğŸ‘‚ğŸ¦»ğŸ¦¶ğŸ¦µğŸ¦¿ğŸ¦¾ğŸ’ªğŸ‘ğŸ‘ğŸ‘ğŸ«¶ğŸ™ŒğŸ‘ğŸ¤²ğŸ¤œğŸ¤›âœŠğŸ‘ŠğŸ«³ğŸ«´ğŸ«±ğŸ«²ğŸ«¸ğŸ«·ğŸ‘‹ğŸ¤šğŸ–ï¸âœ‹ğŸ––ğŸ¤ŸğŸ¤˜âœŒï¸ğŸ¤ğŸ«°ğŸ¤™ğŸ¤ŒğŸ¤ğŸ‘ŒğŸ«µğŸ‘‰ğŸ‘ˆğŸ’…ğŸ™ğŸ¤³âœï¸ğŸ–•ğŸ‘‡ğŸ‘†â˜ï¸ğŸ¤" +
  "ğŸ™‡ğŸ™‹ğŸ’ğŸ™†ğŸ™…ğŸ¤·ğŸ¤¦ğŸ™ğŸ™ğŸ§ğŸ’†ğŸ’‡ğŸ§–ğŸ›€ğŸ›ŒğŸ§˜ğŸ§ğŸ¤¸ğŸ§ğŸ§‘â€ğŸ¦¼ğŸ§‘â€ğŸ¦½ğŸ§‘â€ğŸ¦¯ğŸš¶ğŸƒâ›¹ï¸ğŸ¤¾ğŸš´ğŸšµğŸ§—ğŸ‹ï¸ğŸ¤¼ğŸ¤¹ğŸŒï¸ğŸ‡ğŸ¤ºâ›·ï¸ğŸ‚ğŸª‚ğŸ„ğŸš£ğŸŠğŸ¤½ğŸ§œğŸ§šğŸ§ğŸ§ğŸ§™ğŸ§›ğŸ§ŸğŸ§ŒğŸ¦¸ğŸ¦¹ğŸ¥·ğŸ§‘â€ğŸ„ğŸ‘¼ğŸ’‚ğŸ«…ğŸ¤µğŸ‘°ğŸ§‘â€ğŸš€ğŸ‘·ğŸ‘®ğŸ•µï¸ğŸ§‘â€âœˆï¸ğŸ§‘â€ğŸ”¬ğŸ§‘â€âš•ï¸ğŸ§‘â€ğŸ”§ğŸ§‘â€ğŸ­ğŸ§‘â€ğŸš’ğŸ§‘â€ğŸŒ¾ğŸ§‘â€ğŸ«ğŸ§‘â€ğŸ“ğŸ§‘â€ğŸ’¼ğŸ§‘â€âš–ï¸ğŸ§‘â€ğŸ’»ğŸ§‘â€ğŸ¤ğŸ§‘â€ğŸ¨ğŸ§‘â€ğŸ³ğŸ‘³ğŸ§•ğŸ‘²ğŸ‘¶ğŸ§’ğŸ§‘ğŸ§“ğŸ§‘â€ğŸ¦³ğŸ§‘â€ğŸ¦°ğŸ‘±ğŸ§‘â€ğŸ¦±ğŸ§‘â€ğŸ¦²ğŸ§”ğŸ•´ï¸ğŸ’ƒğŸ•ºğŸ‘¯ğŸ§‘â€ğŸ¤â€ğŸ§‘ğŸ‘­ğŸ‘¬ğŸ‘«ğŸ’‘ğŸ‘©â€â¤ï¸â€ğŸ‘¨ğŸ‘¨â€â¤ï¸â€ğŸ‘¨ğŸ‘©â€â¤ï¸â€ğŸ‘©ğŸ«„ğŸ¤±ğŸ§‘â€ğŸ¼" +
  "ğŸ’ğŸŒ¹ğŸ¥€ğŸŒºğŸŒ·ğŸª·ğŸŒ¸ğŸ’®ğŸµï¸ğŸª»ğŸŒ»ğŸŒ¼ğŸ‚ğŸğŸ„ğŸŒ¾ğŸŒ±ğŸŒ¿ğŸƒâ˜˜ï¸ğŸ€ğŸª´ğŸŒµğŸŒ´ğŸª¾ğŸŒ³ğŸŒ²ğŸªµğŸª¹ğŸªºğŸª¨â›°ï¸ğŸ”ï¸â„ï¸â˜ƒï¸â›„ğŸŒ¡ï¸ğŸ”¥ğŸŒ‹ğŸœï¸ğŸï¸ğŸŒ…ğŸŒ„ğŸï¸ğŸ–ï¸ğŸŒˆğŸ«§ğŸŒŠğŸŒ¬ï¸ğŸŒ€ğŸŒªï¸âš¡â˜”ğŸ’§â˜ï¸ğŸŒ¨ï¸ğŸŒ§ï¸ğŸŒ©ï¸â›ˆï¸ğŸŒ¦ï¸ğŸŒ¥ï¸â›…ğŸŒ¤ï¸â˜€ï¸ğŸŒğŸŒğŸŒšğŸŒœğŸŒ›ğŸŒ™â­ğŸŒŸâœ¨ğŸ•³ï¸ğŸªğŸŒğŸŒğŸŒğŸŒ«ï¸ğŸŒ ğŸŒŒâ˜„ï¸ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜ğŸ¦ğŸ¯ğŸ˜ºğŸ˜¸ğŸ˜¹ğŸ˜»ğŸ˜¼ğŸ˜½ğŸ™€ğŸ˜¿ğŸ˜¾ğŸµğŸ™ˆğŸ™‰ğŸ™ŠğŸ±ğŸ¶ğŸºğŸ»ğŸ»â€â„ï¸ğŸ¨ğŸ¼ğŸ¹ğŸ­ğŸ°ğŸ¦ŠğŸ¦ğŸ®ğŸ·ğŸ½ğŸ—ğŸ¦“ğŸ¦„ğŸ´ğŸ«ğŸ²ğŸ¦ğŸ‰ğŸ¦–ğŸ¦•ğŸ¢ğŸŠğŸğŸ¸ğŸ‡ğŸğŸ€ğŸˆğŸˆâ€â¬›ğŸ©ğŸ•ğŸ¦®ğŸ•â€ğŸ¦ºğŸ–ğŸğŸ«ğŸ„ğŸ‚ğŸƒğŸ¦¬ğŸğŸ‘ğŸğŸ¦ŒğŸ¦™ğŸ¦¥ğŸ¦˜ğŸ˜ğŸ¦£ğŸ¦ğŸ¦›ğŸ¦’ğŸ†ğŸ…ğŸ’ğŸ¦ğŸ¦§ğŸªğŸ«ğŸ¿ï¸ğŸ¦«ğŸ¦¨ğŸ¦¡ğŸ¦”ğŸ¦¦ğŸ¦‡ğŸª½ğŸª¶ğŸ¦ğŸ¦â€â¬›ğŸ“ğŸ”ğŸ£ğŸ¤ğŸ¥ğŸ¦…ğŸ¦‰ğŸ¦œğŸ•Šï¸ğŸ¦¤ğŸ¦¢ğŸ¦†ğŸª¿ğŸ¦©ğŸ¦šğŸ¦â€ğŸ”¥ğŸ¦ƒğŸ§ğŸ¦­ğŸ¦ˆğŸ¬ğŸ‹ğŸ³ğŸŸğŸ ğŸ¡ğŸ¦ğŸ¦ğŸ¦€ğŸ¦‘ğŸ™ğŸª¼ğŸ¦ªğŸª¸ğŸ¦‚ğŸ•·ï¸ğŸ•¸ï¸ğŸšğŸŒğŸœğŸ¦—ğŸª²ğŸ¦ŸğŸª³ğŸª°ğŸğŸğŸ¦‹ğŸ›ğŸª±ğŸ¾" +
  "ğŸ“ğŸ’ğŸğŸ…ğŸŒ¶ï¸ğŸ‰ğŸ‘ğŸŠğŸ¥•ğŸ¥­ğŸğŸŒğŸŒ½ğŸ‹ğŸ‹â€ğŸŸ©ğŸˆğŸğŸ«›ğŸ¥¬ğŸ«‘ğŸğŸ¥ğŸ¥‘ğŸ«’ğŸ¥¦ğŸ¥’ğŸ«ğŸ‡ğŸ†ğŸ ğŸ«œğŸ¥¥ğŸ¥”ğŸ„â€ğŸŸ«ğŸ§…ğŸ«šğŸ§„ğŸ«˜ğŸŒ°ğŸ¥œğŸğŸ«“ğŸ¥ğŸ¥–ğŸ¥¯ğŸ§‡ğŸ¥ğŸ³ğŸ¥šğŸ§€ğŸ¥“ğŸ¥©ğŸ—ğŸ–ğŸ”ğŸŒ­ğŸ¥ªğŸ¥¨ğŸŸğŸ•ğŸ«”ğŸŒ®ğŸŒ¯ğŸ¥™ğŸ§†ğŸ¥˜ğŸğŸ¥«ğŸ«•ğŸ¥£ğŸ¥—ğŸ²ğŸ›ğŸœğŸ¦ªğŸ¦ğŸ£ğŸ¤ğŸ¥¡ğŸšğŸ±ğŸ¥ŸğŸ¢ğŸ™ğŸ˜ğŸ¥ğŸ¡ğŸ¥ ğŸ¥®ğŸ§ğŸ¨ğŸ¦ğŸ¥§ğŸ°ğŸ®ğŸ‚ğŸ§ğŸ­ğŸ¬ğŸ«ğŸ©ğŸªğŸ¯ğŸ§‚ğŸ§ˆğŸ¿ğŸ§ŠğŸ«™ğŸ¥¤ğŸ§‹ğŸ§ƒğŸ¥›ğŸ¼ğŸµâ˜•ğŸ«–ğŸ§‰ğŸºğŸ»ğŸ¥‚ğŸ¾ğŸ·ğŸ¥ƒğŸ«—ğŸ¸ğŸ¹ğŸ¶ğŸ¥¢ğŸ´ğŸ¥„ğŸ”ªğŸ½ï¸" +
  "ğŸš§ğŸš¨â›½ğŸ›¢ï¸ğŸ§­ğŸ›ğŸ›Ÿâš“ğŸšğŸš‡ğŸš¥ğŸš¦ğŸ›´ğŸ¦½ğŸ¦¼ğŸ©¼ğŸš²ğŸ›µğŸï¸ğŸš™ğŸš—ğŸ›»ğŸšğŸššğŸš›ğŸšœğŸï¸ğŸš’ğŸš‘ğŸš“ğŸš•ğŸ›ºğŸšŒğŸšˆğŸšğŸš…ğŸš„ğŸš‚ğŸšƒğŸš‹ğŸšğŸšğŸšŠğŸš‰ğŸšğŸš”ğŸš˜ğŸš–ğŸš†ğŸš¢ğŸ›³ï¸ğŸ›¥ï¸ğŸš¤â›´ï¸â›µğŸ›¶ğŸšŸğŸš ğŸš¡ğŸšğŸ›¸ğŸš€âœˆï¸ğŸ›«ğŸ›¬ğŸ›©ï¸ğŸ›ğŸ¢ğŸ¡ğŸ ğŸªğŸ—¼ğŸ—½ğŸ—¿ğŸ—»ğŸ›ï¸ğŸ’ˆâ›²â›©ï¸ğŸ•ğŸ•ŒğŸ•‹ğŸ›•â›ªğŸ’’ğŸ©ğŸ¯ğŸ°ğŸ—ï¸ğŸ¢ğŸ­ğŸ¬ğŸªğŸŸï¸ğŸ¦ğŸ«ğŸ¨ğŸ£ğŸ¤ğŸ¥ğŸšï¸ğŸ ğŸ¡ğŸ˜ï¸ğŸ›–â›ºğŸ•ï¸â›±ï¸ğŸ™ï¸ğŸŒ†ğŸŒ‡ğŸŒƒğŸŒ‰ğŸŒğŸ›¤ï¸ğŸ›£ï¸ğŸ—¾ğŸ—ºï¸ğŸ’ºğŸ§³" +
  "ğŸ‰ğŸŠğŸˆğŸ‚ğŸ€ğŸğŸ‡ğŸ†ğŸ§¨ğŸ§§ğŸª”ğŸª…ğŸª©ğŸğŸğŸğŸ‘ğŸğŸ‹ğŸ„ğŸƒğŸ—ï¸ğŸ¥‡ğŸ¥ˆğŸ¥‰ğŸ…ğŸ–ï¸ğŸ†ğŸ“¢âš½âš¾ğŸ¥ğŸ€ğŸğŸˆğŸ‰ğŸ¥…ğŸ¾ğŸ¸ğŸ¥ğŸğŸ‘ğŸ’ğŸ¥ŒğŸ›·ğŸ¿â›¸ï¸ğŸ›¼ğŸ©°ğŸ›¹â›³ğŸ¯ğŸ¹ğŸ¥ğŸªƒğŸªğŸ£ğŸ¤¿ğŸ©±ğŸ½ğŸ¥‹ğŸ¥ŠğŸ±ğŸ“ğŸ³â™Ÿï¸ğŸª€ğŸ§©ğŸ®ğŸ•¹ï¸ğŸ‘¾ğŸ”«ğŸ²ğŸ°ğŸ´ğŸ€„ğŸƒğŸª„ğŸ©ğŸ“·ğŸ“¸ğŸ–¼ï¸ğŸ¨ğŸ«ŸğŸ–Œï¸ğŸ–ï¸ğŸª¡ğŸ§µğŸ§¶ğŸ¹ğŸ·ğŸºğŸ¸ğŸª•ğŸ»ğŸª‰ğŸª˜ğŸ¥ğŸª‡ğŸªˆğŸª—ğŸ¤ğŸ§ğŸšï¸ğŸ›ï¸ğŸ™ï¸ğŸ“»ğŸ“ºğŸ“¼ğŸ“¹ğŸ“½ï¸ğŸ¥ğŸï¸ğŸ¬ğŸ­ğŸ«ğŸŸï¸" +
  "ğŸ“±â˜ï¸ğŸ“ğŸ“ŸğŸ“ ğŸ”ŒğŸ”‹ğŸª«ğŸ–²ï¸ğŸ’½ğŸ’¾ğŸ’¿ğŸ“€ğŸ–¥ï¸ğŸ’»âŒ¨ï¸ğŸ–¨ï¸ğŸ–±ï¸ğŸª™ğŸ’¸ğŸ’µğŸ’´ğŸ’¶ğŸ’·ğŸ’³ğŸ’°ğŸ’ğŸ§¾ğŸ§®âš–ï¸ğŸ›’ğŸ›ï¸ğŸ•¯ï¸ğŸ’¡ğŸ”¦ğŸ®ğŸ§±ğŸªŸğŸªğŸšªğŸª‘ğŸ›ï¸ğŸ›‹ï¸ğŸš¿ğŸ›ğŸš½ğŸ§»ğŸª ğŸ§¸ğŸª†ğŸ§·ğŸª¢ğŸ§¹ğŸ§´ğŸ§½ğŸ§¼ğŸª¥ğŸª’ğŸª®ğŸ§ºğŸ§¦ğŸ§¤ğŸ§£ğŸ‘–ğŸ‘•ğŸ½ğŸ‘šğŸ‘”ğŸ‘—ğŸ‘˜ğŸ¥»ğŸ©±ğŸ‘™ğŸ©³ğŸ©²ğŸ§¥ğŸ¥¼ğŸ¦ºâ›‘ï¸ğŸª–ğŸ“ğŸ©ğŸ‘’ğŸ§¢ğŸ‘‘ğŸ’ğŸ’„ğŸª­ğŸ’ğŸ‘ğŸ‘›ğŸ‘œğŸ’¼ğŸ§³â˜‚ï¸ğŸŒ‚ğŸ¥¾ğŸ‘¢ğŸ©´ğŸ‘ ğŸ‘ŸğŸ‘ğŸ¥¿ğŸ‘¡ğŸ¦¯ğŸ•¶ï¸ğŸ‘“ğŸ¥½âš—ï¸ğŸ§«ğŸ§ªğŸŒ¡ï¸ğŸ’‰ğŸ’ŠğŸ©¹ğŸ©ºğŸ©»ğŸ§¬ğŸ”­ğŸ”¬ğŸ“¡ğŸ›°ï¸ğŸ§¯ğŸª“ğŸªœğŸª£ğŸªğŸ§²ğŸ§°ğŸ—œï¸ğŸ”©ğŸª›ğŸªšğŸ”§ğŸ”¨ğŸ› ï¸âš’ï¸â›ï¸ğŸªâš™ï¸â›“ï¸â€ğŸ’¥ğŸ”—â›“ï¸ğŸ“ğŸ–‡ï¸âœ‚ï¸ğŸ“ğŸ“ğŸ–Œï¸ğŸ–ï¸ğŸ–Šï¸ğŸ–‹ï¸âœ’ï¸âœï¸ğŸ“ğŸ—’ï¸ğŸ“„ğŸ“ƒğŸ“‘ğŸ“‹ğŸ—ƒï¸ğŸ—„ï¸ğŸ“’ğŸ“”ğŸ“•ğŸ““ğŸ“—ğŸ“˜ğŸ“™ğŸ“šğŸ“–ğŸ”–ğŸ“‚ğŸ“ğŸ—‚ï¸ğŸ“ŠğŸ“ˆğŸ“‰ğŸ“‡ğŸªªğŸ“ŒğŸ“ğŸ—‘ï¸ğŸ“°ğŸ—ï¸ğŸ·ï¸ğŸ“¦ğŸ“¤ğŸ“¥ğŸ“¨ğŸ“©âœ‰ï¸ğŸ’ŒğŸ“§ğŸ“«ğŸ“ªğŸ“¬ğŸ“­ğŸ“®ğŸ—³ï¸âŒšğŸ•°ï¸âŒ›â³â²ï¸â°â±ï¸ğŸ•›ğŸ•§ğŸ•ğŸ•œğŸ•‘ğŸ•ğŸ•’ğŸ•ğŸ•“ğŸ•ŸğŸ•”ğŸ• ğŸ••ğŸ•¡ğŸ•–ğŸ•¢ğŸ•—ğŸ•£ğŸ•˜ğŸ•¤ğŸ•™ğŸ•¥ğŸ•šğŸ•¦ğŸ“…ğŸ“†ğŸ—“ï¸ğŸª§ğŸ›ï¸ğŸ””ğŸ“¯ğŸ“¢ğŸ“£ğŸ”ˆğŸ”‰ğŸ”ŠğŸ”ğŸ”ğŸ”®ğŸ§¿ğŸª¬ğŸ“¿ğŸºâš±ï¸âš°ï¸ğŸª¦ğŸš¬ğŸ’£ğŸª¤ğŸ“œâš”ï¸ğŸ—¡ï¸ğŸ›¡ï¸ğŸ—ï¸ğŸ”‘ğŸ”ğŸ”ğŸ”’ğŸ”“" +
  "ğŸ”´ğŸŸ ğŸŸ¡ğŸŸ¢ğŸ”µğŸŸ£ğŸŸ¤âš«âšªğŸŸ¥ğŸŸ§ğŸŸ¨ğŸŸ©ğŸŸ¦ğŸŸªğŸŸ«â¬›â¬œâ¤ï¸ğŸ§¡ğŸ’›ğŸ’šğŸ’™ğŸ’œğŸ¤ğŸ–¤ğŸ¤ğŸ©·ğŸ©µğŸ©¶â™¥ï¸â™¦ï¸â™£ï¸â™ ï¸â™ˆâ™‰â™Šâ™‹â™Œâ™â™â™â™â™‘â™’â™“â›â™€ï¸â™‚ï¸âš§ï¸ğŸ’­ğŸ—¯ï¸ğŸ’¬ğŸ—¨ï¸â•â”â—â“â‰ï¸â€¼ï¸â­•âŒğŸš«ğŸš³ğŸš­ğŸš¯ğŸš±ğŸš·ğŸ“µğŸ”ğŸ”•ğŸ”‡ğŸ…°ï¸ğŸ†ğŸ…±ï¸ğŸ…¾ï¸ğŸ†‘ğŸ†˜ğŸ›‘â›”ğŸ“›â™¨ï¸ğŸ”»ğŸ”ºğŸ‰ãŠ™ï¸ãŠ—ï¸ğŸˆ´ğŸˆµğŸˆ¹ğŸˆ²ğŸ‰‘ğŸˆ¶ğŸˆšğŸˆ¸ğŸˆºğŸˆ·ï¸âœ´ï¸ğŸ”¶ğŸ”¸ğŸ”†ğŸ”…ğŸ†šğŸ¦ğŸ“¶ğŸ”ğŸ”‚ğŸ”€â–¶ï¸â©â­ï¸â¯ï¸â—€ï¸âªâ®ï¸ğŸ”¼â«ğŸ”½â¬â¸ï¸â¹ï¸âºï¸âï¸ğŸ“´ğŸ›œğŸ“³ğŸ“²â˜¢ï¸â˜£ï¸âš ï¸ğŸš¸âšœï¸ğŸ”±ã€½ï¸ğŸ”°âœ³ï¸â‡ï¸â™»ï¸ğŸ’±ğŸ’²ğŸ’¹ğŸˆ¯ââœ…âœ”ï¸â˜‘ï¸â¬†ï¸â†—ï¸â¡ï¸â†˜ï¸â¬‡ï¸â†™ï¸â¬…ï¸â†–ï¸â†•ï¸â†”ï¸â†©ï¸â†ªï¸â¤´ï¸â¤µï¸ğŸ”ƒğŸ”„ğŸ”™ğŸ”›ğŸ”ğŸ”šğŸ”œğŸ†•ğŸ†“ğŸ†™ğŸ†—ğŸ†’ğŸ†–â„¹ï¸ğŸ…¿ï¸ğŸˆğŸˆ‚ï¸ğŸˆ³ğŸ”£ğŸ”¤ğŸ” ğŸ”¡ğŸ”¢#ï¸âƒ£*ï¸âƒ£0ï¸âƒ£1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£5ï¸âƒ£6ï¸âƒ£7ï¸âƒ£8ï¸âƒ£9ï¸âƒ£ğŸ”ŸğŸŒğŸ’ ğŸ”·ğŸ”¹ğŸ§â“‚ï¸ğŸš¾ğŸš»ğŸš¹ğŸšºâ™¿ğŸš¼ğŸ›—ğŸš®ğŸš°ğŸ›‚ğŸ›ƒğŸ›„ğŸ›…ğŸ’Ÿâš›ï¸ğŸ›ğŸ•‰ï¸â˜¸ï¸â˜®ï¸â˜¯ï¸â˜ªï¸ğŸª¯âœï¸â˜¦ï¸âœ¡ï¸ğŸ”¯ğŸ•â™¾ï¸ğŸ†”ğŸ§‘â€ğŸ§‘â€ğŸ§’ğŸ§‘â€ğŸ§‘â€ğŸ§’â€ğŸ§’ğŸ§‘â€ğŸ§’ğŸ§‘â€ğŸ§’â€ğŸ§’âš•ï¸ğŸ¼ğŸµğŸ¶âœ–ï¸â•â–â—ğŸŸ°â°â¿ã€°ï¸Â©ï¸Â®ï¸â„¢ï¸ğŸ”˜ğŸ”³â—¼ï¸â—¾â–ªï¸ğŸ”²â—»ï¸â—½â–«ï¸ğŸ‘ï¸â€ğŸ—¨ï¸"
)].map(s => s.segment);

function renderEmojiList(){
  mediaContent.innerHTML = ""; // åˆæœŸåŒ–
  for(let i = 0; i < emoji_list.length; i++){
    const item = document.createElement("div");
    item.className = "media-item";
    item.dataset.type = "emoji";
    item.dataset.id = String(i + 1); // idã¯1å§‹ã¾ã‚Š
    item.textContent = emoji_list[i];
    mediaContent.appendChild(item);
  }
}
renderEmojiList();

function renderStampList(){
  mediaContent.innerHTML = "";

  for(let i = 0; i < 7; i++){ //åŸç¥ã‚¹ã‚¿ãƒ³ãƒ—æç”»
    const item = document.createElement("div");
    item.className = "media-item";
    item.dataset.type = "stamp";
    item.dataset.id = "genshin/" + String(i + 1);
    const img = document.createElement("img");
    img.src = `/game-sites/chat/stamp/genshin/${i + 1}.png`;
    img.loading = "lazy";      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    img.alt = `genshin-stamp-${i + 1}`;

    item.appendChild(img);
    mediaContent.appendChild(item);
  }

  for(let i = 0; i < 11; i++){ //ä»–ã‚¹ã‚¿ãƒ³ãƒ—æç”»
    const item = document.createElement("div");
    item.className = "media-item";
    item.dataset.type = "stamp";
    item.dataset.id = "other/" + String(i + 1);
    const img = document.createElement("img");
    img.src = `/game-sites/chat/stamp/other/${i + 1}.png`;
    img.loading = "lazy";      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    img.alt = `other-stamp-${i + 1}`;

    item.appendChild(img);
    mediaContent.appendChild(item);
  }
}

function renderGifList(){
  mediaContent.innerHTML = "";

  for(let i = 0; i < 4; i++){ //åŸç¥GIFæç”»
    const item = document.createElement("div");
    item.className = "media-item";
    item.dataset.type = "gif";
    item.dataset.id = "genshin/" + String(i + 1);
    const img = document.createElement("img");
    img.src = `/game-sites/chat/gif/genshin/${i + 1}.gif`;
    img.loading = "lazy";      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    img.alt = `genshin-gif-${i + 1}`;

    item.appendChild(img);
    mediaContent.appendChild(item);
  }

  for(let i = 0; i < 1; i++){ //ã‚¹ã‚¿ãƒ¬GIFæç”»
    const item = document.createElement("div");
    item.className = "media-item";
    item.dataset.type = "gif";
    item.dataset.id = "starrail/" + String(i + 1);
    const img = document.createElement("img");
    img.src = `/game-sites/chat/gif/starrail/${i + 1}.gif`;
    img.loading = "lazy";      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    img.alt = `starrail-gif-${i + 1}`;

    item.appendChild(img);
    mediaContent.appendChild(item);
  }

  for(let i = 0; i < 3; i++){ //ä»–GIFæç”»
    const item = document.createElement("div");
    item.className = "media-item";
    item.dataset.type = "gif";
    item.dataset.id = "other/" + String(i + 1);
    const img = document.createElement("img");
    img.src = `/game-sites/chat/gif/other/${i + 1}.gif`;
    img.loading = "lazy";      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    img.alt = `other-gif-${i + 1}`;

    item.appendChild(img);
    mediaContent.appendChild(item);
  }
}


    /* ======== Google Apps Script Web App URL ======== */
    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycbyKOg1ktDml2MFAr6kOuEjXRyzZ2u2B76mp6wpqaUp6Hn0NzZPBJsW2EchaYT_y1ZTuhA/exec";

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID â†’ ã‚¢ã‚¤ã‚³ãƒ³URL
    const userIcons = {
      default:      "/game-sites/chat/chatIcons/default-0001.png",
      wakaruwakaru: "/game-sites/chat/chatIcons/wakaruwakaru-0001.png",
      dabada:       "/game-sites/chat/chatIcons/dabada-0001.png",
      173:          "/game-sites/chat/chatIcons/173-0001.png",
      RTX5090rairai:"/game-sites/chat/chatIcons/rairai-0001.png"
    };

    /* ======== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ ======== */
    async function send() {
      const box = document.getElementById("textBox1");
      const text = box.value.trim();
      if (!text) return;
      
      scrollToBottom();
      // å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
      box.value = "";
      box.focus();

      const text2 = text_trim(text, "message");
      sendToGAS(token3, text2, "chat"); // GAS ã¸é€ä¿¡
    }

    /* ============ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚°=========== */
    async function send_login() {
      const text2 = text_trim("", "login");
      sendToGAS(token3, text2, "chat"); // GAS ã¸é€ä¿¡
    }
    
    /* ======== GASã«é€ä¿¡ã™ã‚‹å‡¦ç† ======== */
    async function sendToGAS(user, text, status){
      const Auser = user.account;
      const payload = {
        Auser,
        message: text,
        status
      };

      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",   // â† GAS ãŒ CORS è¨±å¯ã—ã¦ãªã„ãŸã‚å¿…è¦
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        // no-cors ã®ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯èª­ã‚ãªã„ï¼ˆä»•æ§˜ï¼‰
      } catch (e) {
        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
      }
    }


/* ======== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ ï¼ˆå—ä¿¡å´ï¼‰ ======== */
function addMessage_received(user, type, time, value){
  const iconURL = userIcons[user] || userIcons["default"];
  const msg = document.createElement("div");
  msg.className = "message received";

  // --- ã‚¢ã‚¤ã‚³ãƒ³ ---
  const icon = document.createElement("div");
  icon.className = "user-icon";
  icon.style.backgroundImage = `url('${iconURL}')`;
  // --- æœ¬ä½“ ---
  const content = document.createElement("div");
  content.className = "message-content";
  // --- ä¸­èº« ---
  const body = createMessageBody(type, value);
  if(body) content.appendChild(body);
  // --- æ™‚åˆ» ---
  const ts = document.createElement("span");
  ts.className = "timestamp";
  ts.textContent = time;

  content.appendChild(ts);
  msg.append(icon, content);
  document.getElementById("message1").appendChild(msg);
}

/* ======== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ ï¼ˆé€ä¿¡å´ï¼‰ ======== */
function addMessage_sent(type, time, value){
  const msg = document.createElement("div");
  msg.className = "message sent";

  // --- æœ¬ä½“ ---
  const content = document.createElement("div");
  content.className = "message-content";
  // --- ä¸­èº« ---
  const body = createMessageBody(type, value);
  if(body) content.appendChild(body);
  // --- æ™‚åˆ» ---
  const ts = document.createElement("span");
  ts.className = "timestamp";
  ts.textContent = time;

  content.appendChild(ts);
  msg.appendChild(content);
  document.getElementById("message1").appendChild(msg);
}


function createMessageBody(type, value){
  switch(type){
    case "message":{
      const p = document.createElement("p");
      p.textContent = value;
      return p;
    }
    case "emoji":{
      const p = document.createElement("p");
      p.textContent = emoji_list[Number(value) - 1];
      p.className = "emoji";
      return p;
    }
    case "stamp":{
      const img = document.createElement("img");
      img.src = "/game-sites/chat/stamp/" + value + ".png";
      img.loading = "lazy";
    //img.className = "media-img";
      return img;
    }
    case "gif":{
      const img = document.createElement("img");
      img.src = "/game-sites/chat/gif/" + value + ".gif";
      img.loading = "lazy";
    //img.className = "media-img";
      return img;
    }

    default:
      console.warn("æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:", type);
      return null;
  }
}


/*=============æ™‚é–“ãƒ”ãƒ«è¿½åŠ ==============*/
function addDatePill(text){
  // ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆä¸­å¤®å¯„ã›ï¼‰
  const wrapper = document.createElement("div");
  wrapper.className = "center-set";
  // ãƒ”ãƒ«æœ¬ä½“ï¼ˆè¦‹ãŸç›®ï¼‰
  const pill = document.createElement("div");
  pill.className = "chat-date-pill";
  pill.textContent = text;
  // wrapper ã®ä¸­ã« pill ã‚’å…¥ã‚Œã‚‹
  wrapper.appendChild(pill);
  // message1 ã«æŒ¿å…¥
  document.getElementById("message1").appendChild(wrapper);
}

    /* ======== è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ======== */
    function scrollToBottom(){
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth"
      });
    }

    /* ======== ã‚¨ãƒ³ã‚¿ãƒ¼é€ä¿¡ ======== */
    function enterSend(e){
      if(e.isComposing) return;
      if(e.key === "Enter") send();
    }
    
    function text_trim(text1, text2){
      return `<type[${text2}]acco[${token3}]time[${new Date()}]val1[${text1}]>`;
    }

const box = document.getElementById("textBox1");
box.addEventListener("keydown", (e) => {  // ã‚­ãƒ¼å…¥åŠ›ã‚’ãƒ–ãƒ­ãƒƒã‚¯
  if(["<", ">", "[", "]"].includes(e.key)){
    e.preventDefault();
  }
});
box.addEventListener("input", () => {  // ã¾ã¨ã‚ã¦é™¤å»
  box.value = box.value.replace(/[<>\[\]]/g, "");
});


function splitLogs(text){
  return text.match(/<[^>]*>/g) || [];
}

function parseLog(log){
  const result = {};
  const inside = log.slice(1, -1);
  const parts = inside.split("]");

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i].trim();
    if (part === "") continue;

    const keyValue = part.split("[");
    const key = keyValue[0];
    const value = keyValue[1];

    result[key] = value;
  }
  return result;
}

function toHHMM(timeString) {
  const d = new Date(timeString); // æ–‡å­—åˆ— â†’ Date ã«å¤‰æ›
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");
  return `${hh}:${mm}`;
}
function toYYYYMMDD(dateString) {
  const d = new Date(dateString);
  const year  = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day   = String(d.getDate()).padStart(2, "0");
  return `${year}å¹´${month}æœˆ${day}æ—¥`;
}

function getScrollPercentage(){
    const currentScroll = window.scrollY;                      // A. ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ï¼ˆä¸Šç«¯ã‹ã‚‰ã®è·é›¢ï¼‰
    const fullHeight = document.documentElement.scrollHeight;  // B. ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã®é«˜ã•
    const viewportHeight = window.innerHeight;                 // C. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆï¼ˆè¡¨ç¤ºé ˜åŸŸï¼‰ã®é«˜ã•
    // ----------------------------------------------------
    // 2. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªæœ€å¤§ã®è·é›¢ã‚’è¨ˆç®—   ãƒšãƒ¼ã‚¸å…¨é•·ã‹ã‚‰è¡¨ç¤ºé ˜åŸŸã®åˆ†ã‚’å¼•ã
    const maxScrollDistance = fullHeight - viewportHeight;
    // æœ€å¤§è·é›¢ãŒ0ã®å ´åˆã¯ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ããªã„ï¼ˆãƒšãƒ¼ã‚¸ãŒçŸ­ã„ï¼‰ãŸã‚0%ã‚’è¿”ã™
    if (maxScrollDistance === 0) {
        return 0;
    }
    // ----------------------------------------------------
    // 3. ç›¸å¯¾å€¤ï¼ˆ%ï¼‰ã‚’è¨ˆç®—ã—ã€å°æ•°ç‚¹ä»¥ä¸‹ã‚’ä¸¸ã‚ã‚‹
    const scrollPercentage = (currentScroll / maxScrollDistance) * 100;
    // 0ã€œ100ã®é–“ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ï¼ˆå¿µã®ãŸã‚ï¼‰
    return Math.min(100, Math.max(0, scrollPercentage));
}
    
function autoScrollValue(){
    const currentScroll = window.scrollY;
    const fullHeight = document.documentElement.scrollHeight;
    const viewportHeight = window.innerHeight;
    const ScrollDistance = (fullHeight - viewportHeight) - currentScroll;
    if(100 < ScrollDistance){
      return 0;
    }else{
      return 1;
    }
}

const msg1 = document.getElementById("new-msg");
function new_msg(text){
  msg1.textContent = text;
  msg1.classList.add("show");
  /* 1.5ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  setTimeout(() => {
    msg1.classList.remove("show");
  }, 1500);
  */
}

function diffSeconds(get_old_date) {
  const oldTime = new Date(get_old_date).getTime();  // éå»ã®æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
  const nowTime = Date.now();                    // ç¾åœ¨ã®æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
  const diffMs = nowTime - oldTime;              // ãƒŸãƒªç§’å·®
  return Math.floor(diffMs / 1000);              // ç§’ã«å¤‰æ›
}
    
var old_content = 0;
var new_content = 0;
var old_mess_date = "";
var new_mess_date = "";
var new_message = 0;
var renew_time = 0;
async function page_update(){
  const res = await fetch(WEB_APP_URL);
  const data = await res.json();
  const text1 = data.content;

  // â‘  æ–‡å­—åˆ—ã‚’ãƒ­ã‚°ã”ã¨ã«é…åˆ—ã¸
  const logs = splitLogs(text1);

  // â‘¡ ãã‚Œãã‚Œã®ãƒ­ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹ â†’ å¤šæ¬¡å…ƒé…åˆ—ã¸
  const message2 = logs.map(log => {
    const p = parseLog(log);
    return [ p.type, p.acco, p.time, p.val1 ];
  });

  // â‘¢ å‡ºåŠ›
  renew_time = new Date();
  old_content = new_content;
  new_content = message2.length;
  if(old_content != new_content){
    const auto_scroll = autoScrollValue();
    for(let i = old_content; i < message2.length; i++){
      if((message2[i][0] == "message") || (message2[i][0] == "emoji") || (message2[i][0] == "stamp") || (message2[i][0] == "gif")){
        old_mess_date = new_mess_date;
        new_mess_date = toYYYYMMDD(message2[i][2]);
        if(old_mess_date != new_mess_date){
          addDatePill(new_mess_date);
        }
        if(message2[i][1] == token3){
          addMessage_sent(message2[i][0], toHHMM(message2[i][2]), message2[i][3]); //type time value
        }else{
          addMessage_received(message2[i][1], message2[i][0], toHHMM(message2[i][2]), message2[i][3]); //user type time value
          if((!auto_scroll) && (!new_message)){
            new_message = 1;
            new_msg("æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸");
          }
        }
      }
    }
    if(auto_scroll){
      scrollToBottom();
    }
  }

}

let ticking = false;
window.addEventListener("scroll", () => {
  if(!ticking){
    window.requestAnimationFrame(() => {
      if((autoScrollValue()) && (new_message)){
        msg1.classList.remove("show");
        new_message = 0;
      }
      ticking = false;
    });
    ticking = true;
  }
});

    
var timer1 = null;
var update_rate = 1000;
function event1() {
  page_update();
}
timer1 = setInterval(event1, update_rate);
function rate_change(){
  if(update_rate === 1000) {
    document.querySelector(".icon-right").style.backgroundColor = "#7dd6ff";
    update_rate = 5000;
  }else{
    document.querySelector(".icon-right").style.backgroundColor = "#000000";
    update_rate = 1000;
  }
  clearInterval(timer1);
  timer1 = setInterval(event1, update_rate);
}

var timer2 = null;
function event2(){
  if(renew_time != 0){
    if(diffSeconds(renew_time) < 60){
      document.getElementById("last-change-time").innerHTML = "æœ€çµ‚æ›´æ–°: " + diffSeconds(renew_time) + "ç§’å‰";
    }else{
      document.getElementById("last-change-time").innerHTML = "æœ€çµ‚æ›´æ–°: " + toHHMM(renew_time);
    }
  }
}timer2 = setInterval(event2, 200);

setInterval(() => {
  sendToGAS(token3, "", "chat");
}, 5000);

  const urlParams = new URLSearchParams(location.search);
  const token1 = urlParams.get("key1");
  const token3 = localStorage.getItem("account1");
  localStorage.setItem("account1", "");
  if((token1 !== localStorage.getItem("key1")) || (token3 == "")){
    localStorage.setItem("key1", "unauthorized");
    localStorage.setItem("requestPage1", "chat/chat0001/chat0001-3");
    location.href = "/game-sites/";
  }else{
    localStorage.setItem("key1", "");
    localStorage.setItem("requestPage1", "");
    send_login();
  }

  function reload(){
    const key1 = crypto.randomUUID();
    localStorage.setItem("key1", key1);
    localStorage.setItem("account1", token3);
    location.href = "/game-sites/chat/chat0001/chat0001-3?key1=" + key1;
  }
  function backPage(){
    const key1 = crypto.randomUUID();
    localStorage.setItem("key1", key1);
    localStorage.setItem("account1", token3);
    location.href = "/game-sites/top/top0001/top0001?key1=" + key1;
  }
</script>
</html>
